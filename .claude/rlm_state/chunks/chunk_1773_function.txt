<!-- Chunk 1773: bytes 7417274-7420294, type=function -->
def metadata_metric(
    gold: dspy.Example,
    pred: dspy.Prediction,
    trace: Any = None,
) -> float:
    """
    Evaluate metadata completeness and accuracy.

    Scoring:
    - Name matches: 0.3
    - Type matches: 0.2
    - Weight matches: 0.1
    - Capabilities overlap: 0.4

    Args:
        gold: Example with expected metadata fields
        pred: Prediction with plan.skill_metadata
        trace: Optional trace information

    Returns:
        Score between 0.0 and 1.0

    """
    if isinstance(pred, dict):
        plan = pred.get("plan")
    else:
        plan = getattr(pred, "plan", None)

    if plan is None:
        return 0.0

    if isinstance(plan, dict):
        metadata = plan.get("skill_metadata", {})
    else:
        metadata = getattr(plan, "skill_metadata", {})

    if isinstance(metadata, str):
        try:
            metadata = json.loads(metadata)
        except json.JSONDecodeError:
            return 0.0

    if not metadata:
        return 0.0

    score = 0.0

    # Helper to get field from metadata (dict or object)
    def get_meta_field(field: str) -> Any:
        """
        Extract a field value from metadata that may be either a dict or object.

        Args:
            field: The field name to extract

        Returns:
            The field value if found, None otherwise

        """
        if isinstance(metadata, dict):
            return metadata.get(field)
        return getattr(metadata, field, None)

    # Name match
    expected_name = getattr(gold, "expected_name", "")
    pred_name = get_meta_field("name") or ""
    if pred_name.lower() == expected_name.lower():
        score += 0.3
    elif expected_name.lower() in pred_name.lower() or pred_name.lower() in expected_name.lower():
        score += 0.15

    # Type match
    expected_type = getattr(gold, "expected_type", "")
    pred_type = get_meta_field("type") or ""
    if pred_type.lower() == expected_type.lower():
        score += 0.2

    # Weight match
    expected_weight = getattr(gold, "expected_weight", "")
    pred_weight = get_meta_field("weight") or ""
    if pred_weight.lower() == expected_weight.lower():
        score += 0.1

    # Capabilities overlap
    expected_caps = set(getattr(gold, "expected_capabilities", []))
    pred_caps_raw = get_meta_field("capabilities") or []

    # Handle capabilities that might be list of objects or strings
    pred_caps = set()
    for cap in pred_caps_raw:
        if isinstance(cap, str):
            pred_caps.add(cap.lower())
        elif isinstance(cap, dict):
            pred_caps.add(cap.get("name", "").lower())
        elif hasattr(cap, "name"):
            pred_caps.add(cap.name.lower())

    expected_caps_lower = {c.lower() for c in expected_caps}

    if expected_caps_lower and pred_caps:
        overlap = len(expected_caps_lower & pred_caps)
        union = len(expected_caps_lower | pred_caps)
        jaccard = overlap / union if union > 0 else 0
        score += jaccard * 0.4

    return min(score, 1.0)


