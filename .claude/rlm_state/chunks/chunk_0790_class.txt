<!-- Chunk 790: bytes 2651364-2657858, type=class -->
class CreateSkillRequest(BaseModel):
    task_description: str

    @validator('task_description')
    def validate_task_description(cls, v):
        if "test" in v.lower():
            raise ValueError("task_description cannot contain 'test'")
        if len(v.split()) < 3:
            raise ValueError("task_description must be at least 3 words")
        return v
```

---

## See Also

- **[API Overview](index.md)** - Architecture and setup
- **[Endpoints Documentation](endpoints.md)** - Endpoint reference
- **[DSPy Signatures](../dspy/signatures.md)** - DSPy signature contracts


============================================================
END FILE: docs/api/schemas.md
============================================================

============================================================
FILE: docs/architecture/BACKGROUND_JOBS.md
============================================================

# Background Job Processing for Skill Creation

`★ Insight ─────────────────────────────────────`
**DSPy + Background Jobs Architecture:**
- Skills are created by AI agents via DSPy optimization programs
- These programs run asynchronously as background jobs
- The `jobs` table tracks the entire lifecycle from request to completion
- Human-in-the-Loop (HITL) interactions allow user feedback during execution
`─────────────────────────────────────────────────`

## Overview

The skills-fleet system uses background jobs to handle long-running skill creation workflows. When a user requests a new skill, a job is created that:

1. **Refines the task description** (DSPy enhancement)
2. **Gathers deep understanding** (asks clarifying questions)
3. **Runs TDD workflow** (RED → GREEN → REFACTOR)
4. **Validates the result** (quality checks)
5. **Promotes to production** (moves draft → active)

## Database Schema

### Core Tables

```sql
-- Jobs table: Tracks all background jobs
CREATE TABLE jobs (
    job_id UUID PRIMARY KEY,
    status job_status_enum,          -- pending, running, pending_hitl, completed, failed
    job_type VARCHAR(64),             -- skill_creation, optimization, etc.
    user_id VARCHAR(128),
    task_description TEXT,            -- Original user request
    task_description_refined TEXT,    -- AI-enhanced description
    current_phase VARCHAR(64),        -- Current workflow phase
    progress_message TEXT,
    progress_percent INTEGER,
    result JSONB,                     -- Final result
    error TEXT,
    draft_path TEXT,                  -- Where draft skill is stored
    final_path TEXT,                  -- Where published skill lives
    promoted BOOLEAN DEFAULT FALSE,
    validation_passed BOOLEAN,
    validation_score FLOAT,
    created_at TIMESTAMPTZ,
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ
);

-- HITL interactions: Human-in-the-Loop feedback
CREATE TABLE hitl_interactions (
    interaction_id SERIAL PRIMARY KEY,
    job_id UUID REFERENCES jobs(job_id),
    interaction_type hitl_type_enum,  -- clarify, confirm, preview, validate, tdd_*
    prompt_data JSONB,                -- Question presented to user
    response_data JSONB,              -- User's response
    status VARCHAR(32),               -- pending, responded, timeout
    created_at TIMESTAMPTZ
);

-- Deep Understanding State
CREATE TABLE deep_understanding_state (
    state_id SERIAL PRIMARY KEY,
    job_id UUID REFERENCES jobs(job_id),
    questions_asked JSONB,
    answers JSONB,
    research_performed JSONB,
    understanding_summary TEXT,
    user_problem TEXT,
    user_goals TEXT[],
    readiness_score FLOAT,
    complete BOOLEAN
);

-- TDD Workflow State
CREATE TABLE tdd_workflow_state (
    state_id SERIAL PRIMARY KEY,
    job_id UUID REFERENCES jobs(job_id),
    phase VARCHAR(32),                -- red, green, refactor
    baseline_tests_run BOOLEAN,
    compliance_tests_run BOOLEAN,
    rationalizations_identified TEXT[],
    checklist_state JSONB
);
```

## Job Lifecycle

```
┌─────────────────────────────────────────────────────────────────┐
│                     JOB LIFECYCLE                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. PENDING                                                     │
│     ├── Job queued, waiting for worker                          │
│     └── user_id, task_description stored                        │
│                                                                  │
│  2. RUNNING                                                     │
│     ├── Worker picks up job                                     │
│     ├── Phase 1: Task Refinement (DSPy)                         │
│     ├── Phase 2: Deep Understanding (HITL)                      │
│     │    └── May transition to PENDING_HITL                     │
│     ├── Phase 3: TDD Workflow                                   │
│     │    ├── RED: Write failing tests                           │
│     │    ├── GREEN: Make tests pass                             │
│     │    └── REFACTOR: Improve code                             │
│     └── Phase 4: Validation                                    │
│                                                                  │
│  3. PENDING_HITL (Human-in-the-Loop)                           │
│     ├── Worker waiting for user input                           │
│     ├── User prompted via API/WebSocket                         │
│     └── On response → RUNNING                                  │
│                                                                  │
│  4. COMPLETED                                                   │
│     ├── All phases finished                                     │
│     ├── result JSONB populated                                  │
│     ├── draft_path set                                          │
│     └── Promoted to skills table (if validated)                │
│                                                                  │
│  5. FAILED                                                      │
│     ├── error TEXT populated                                    │
│     └── error_stack for debugging                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Implementation

### Job Creation

```python
from skill_fleet.db.repositories import JobRepository
from skill_fleet.db.models import job_status_enum
import uuid

