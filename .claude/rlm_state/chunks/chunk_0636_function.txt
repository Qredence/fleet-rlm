<!-- Chunk 636: bytes 992698-994073, type=function -->
def taxonomy_accuracy_metric(example: dspy.Example, prediction: dspy.Prediction, trace=None) -> float:
    """Evaluate taxonomy path prediction accuracy.
    
    More sophisticated metric focusing on taxonomy placement.
    Used in production for Phase 1 (Understanding) optimization.
    
    Args:
        example: Example with expected_taxonomy_path
        prediction: Prediction with taxonomy_path
        trace: Optional trace (unused)
    
    Returns:
        Score 0.0-1.0 (1.0 = exact match, 0.7 = category match, 0.0 = miss)
    """
    if not hasattr(example, "expected_taxonomy_path"):
        return 0.5  # Neutral if no expectation
    
    expected = example.expected_taxonomy_path
    
    # Try different field names
    predicted = None
    for field in ["taxonomy_path", "recommended_path", "path"]:
        if hasattr(prediction, field):
            predicted = getattr(prediction, field)
            break
    
    if not predicted:
        return 0.0
    
    # Exact match: full score
    if predicted == expected:
        return 1.0
    
    # Category match: partial credit
    expected_category = expected.split("/")[0] if "/" in expected else expected
    predicted_category = predicted.split("/")[0] if "/" in predicted else predicted
    
    if expected_category.lower() == predicted_category.lower():
        return 0.7
    
    return 0.0


