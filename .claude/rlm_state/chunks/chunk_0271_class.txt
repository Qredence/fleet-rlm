<!-- Chunk 271: bytes 342296-343833, type=class -->
class SharedStateDetector(ast.NodeVisitor):
    """Detect patterns that suggest shared state issues."""

    def __init__(self, filepath: str):
        self.filepath = filepath
        self.issues: list[dict[str, Any]] = []
        self.module_level_assignments: list[dict[str, Any]] = []
        self.singleton_patterns: list[dict[str, Any]] = []

    def visit_Module(self, node: ast.Module) -> None:
        """Check for module-level mutable state."""
        for item in node.body:
            # Module-level mutable assignments (excluding imports, classes, functions)
            if isinstance(item, ast.Assign):
                for target in item.targets:
                    if isinstance(target, ast.Name):
                        # Check if it's a mutable type
                        if isinstance(item.value, (ast.List, ast.Dict, ast.Set, ast.Call)):
                            self.issues.append({
                                "type": "module_level_mutable",
                                "severity": "info",
                                "line": item.lineno,
                                "name": target.id,
                                "message": (
                                    f"Module-level mutable `{target.id}` can cause issues "
                                    f"if modified during concurrent requests. Consider making "
                                    f"it immutable or request-scoped."
                                ),
                            })

        self.generic_visit(node)


