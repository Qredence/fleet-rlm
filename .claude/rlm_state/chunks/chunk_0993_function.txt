<!-- Chunk 993: bytes 3454845-3483940, type=function -->
def create_command(
    ctx: typer.Context,
    task: str,
    auto_approve: bool = False,
) -> None:
    ...
```

**Step 3: Run type checker**

```bash
uv run mypy src/skill_fleet/cli/ || true
```

**Step 4: Commit**

```bash
git add src/skill_fleet/cli/
git commit -m "refactor(cli): add type hints to all public functions

- Add return type annotations (None for commands)
- Add parameter type annotations
- Use proper typer.Context types

Fixes missing type hints from cli-best-practices-review.md"
```

---

## Task 11: Run Full Test Suite and Fix Issues

**Files:**
- Modify: Various files as needed

**Step 1: Run all CLI tests**

```bash
uv run pytest tests/cli/ -v --cov=src/skill_fleet/cli --cov-report=term-missing
```

**Step 2: Run ruff linting**

```bash
uv run ruff check src/skill_fleet/cli/
uv run ruff check --fix src/skill_fleet/cli/
```

**Step 3: Run ruff formatting**

```bash
uv run ruff format src/skill_fleet/cli/
```

**Step 4: Fix any remaining issues**

Address any test failures or linting issues found.

**Step 5: Commit**

```bash
git add src/skill_fleet/cli/ tests/cli/
git commit -m "test(cli): ensure all tests pass and code is formatted

- Run full test suite with coverage
- Fix any remaining test failures
- Apply ruff formatting
- Fix linting issues"
```

---

## Task 12: Create Summary Documentation

**Files:**
- Create: `docs/plans/2026-01-12-cli-optimization-summary.md`

**Step 1: Create summary document**

Create `docs/plans/2026-01-12-cli-optimization-summary.md`:

```markdown
# CLI Optimization and Fix - Summary

**Date:** 2026-01-12
**Status:** Completed

## Changes Made

### Security (High Priority)
- ✅ Added `validate_path_within_root()` to prevent path traversal
- ✅ Added `sanitize_user_id()` to prevent injection attacks
- ✅ Added `validate_api_url()` to enforce secure protocols
- ✅ Added validation callbacks to CLI options

### Error Handling (High Priority)
- ✅ Created custom exception classes (CLIError, ConfigError, APIError, ValidationError)
- ✅ Replaced bare `except Exception` with specific exceptions
- ✅ Added consistent Rich-formatted error display
- ✅ Added actionable suggestions to error messages

### Code Quality (Medium Priority)
- ✅ Created singleton console manager (13 instances → 1)
- ✅ Extracted magic numbers to constants module
- ✅ Added Rich color palette for consistent theming
- ✅ Added type hints to all public functions

### Testing (High Priority)
- ✅ Added test coverage for security utilities
- ✅ Added test coverage for custom exceptions
- ✅ Added test coverage for console manager
- ✅ Added tests for CLI commands

## Files Created

### New Source Files
- `src/skill_fleet/cli/exceptions.py` - Custom exception classes
- `src/skill_fleet/cli/utils/security.py` - Input validation utilities
- `src/skill_fleet/cli/utils/constants.py` - Configuration constants
- `src/skill_fleet/cli/utils/console.py` - Singleton console manager

### New Test Files
- `tests/cli/test_security_utils.py` - Security utilities tests
- `tests/cli/test_exceptions.py` - Exception class tests
- `tests/cli/test_constants.py` - Constants tests
- `tests/cli/test_console.py` - Console manager tests
- `tests/cli/test_app.py` - App configuration tests
- `tests/cli/test_create_command.py` - Create command tests
- `tests/cli/test_validate_command.py` - Validate command tests
- `tests/cli/test_remaining_commands.py` - Other command tests

### Modified Files
- `src/skill_fleet/cli/app.py` - Added security validation
- `src/skill_fleet/cli/client.py` - Added timeout support
- `src/skill_fleet/cli/commands/create.py` - Improved error handling
- `src/skill_fleet/cli/commands/validate.py` - Added path validation
- `src/skill_fleet/cli/commands/list_skills.py` - Standardized error handling
- `src/skill_fleet/cli/utils/__init__.py` - Export utilities

## Remaining Work (Future)

### Low Priority
- [ ] Add integration tests for full command workflows
- [ ] Add performance tests for long-running commands
- [ ] Refactor long functions (>50 lines) into smaller units
- [ ] Add more usage examples in docstrings
- [ ] Consider removing old argparse main.py after migration

### Documentation
- [ ] Update CLI reference documentation
- [ ] Add security guide for contributors
- [ ] Document exit code conventions

## Verification

To verify the fixes:

```bash
# Run all tests
uv run pytest tests/cli/ -v

# Run linting
uv run ruff check src/skill_fleet/cli/

# Test CLI
uv run skill-fleet --help
uv run skill-fleet create "test skill" --help
uv run skill-fleet validate --help
```

## Related Reviews

- `docs/plans/cli-security-review.md` - Security vulnerability findings
- `docs/plans/cli-error-handling-review.md` - Error handling issues
- `docs/plans/cli-best-practices-review.md` - Code quality findings
- `docs/plans/cli-dependencies-review.md` - Dependency issues
```

**Step 2: Commit summary**

```bash
git add docs/plans/2026-01-12-cli-optimization-summary.md
git commit -m "docs: add CLI optimization summary

Document all changes made during CLI optimization and fix.
Lists new files, modified files, remaining work, and verification steps."
```

---

## Summary

This implementation plan addresses all critical and high-priority issues identified in the CLI code reviews:

1. **Security** - Path traversal prevention, input sanitization, URL validation
2. **Error Handling** - Custom exceptions, consistent formatting, actionable messages
3. **Code Quality** - Singleton console, constants, type hints
4. **Testing** - Comprehensive test coverage for utilities and commands

`★ Insight ─────────────────────────────────────`
**Key Design Decisions:**
1. **Singleton Pattern**: Console manager uses module-level singleton to reduce 13 Console() instances to 1, improving memory efficiency and ensuring consistent output formatting.
2. **Custom Exceptions**: Exception classes include exit codes and suggestions, enabling automated error display with actionable guidance.
3. **Security-First Validation**: All user inputs validated before use, preventing path traversal and injection attacks at the boundary.
`─────────────────────────────────────────────────`

**Estimated Effort:** 2-3 days for full implementation
**Expected Deliverables:** 12 new modules/files, comprehensive test coverage, security fixes


============================================================
END FILE: docs/internal/plans/archive/2026-01-12-cli-optimization-fix.md
============================================================

============================================================
FILE: docs/internal/plans/archive/2026-01-12-documentation-expansion.md
============================================================

# Skills Fleet Documentation Expansion Design

**Date**: 2026-01-12
**Status**: Approved
**Audience**: Both end users/operators and contributors/developers

## Overview

This document outlines the comprehensive expansion of the skills-fleet documentation to provide extensive conceptual and technical coverage of the entire system. The documentation targets both users (operators) and developers, using a hierarchical structure with overview pages linking to detailed content.

## Goals

1. Provide comprehensive documentation for DSPy usage (signatures, modules, programs, optimization)
2. Document the FastAPI REST API (endpoints, schemas, middleware, jobs)
3. Document the CLI including interactive chat mode
4. Document LLM configuration (providers, task-specific models)
5. Document the HITL (Human-in-the-Loop) system
6. Ensure all relevant aspects of `src/skill_fleet/` are covered

## Documentation Structure

```
docs/
├── intro/
│   ├── introduction.md          (expand existing)
│   └── quick-start.md           (new)
│
├── getting-started/
│   ├── index.md                 (expand existing)
│   ├── installation.md          (new)
│   └── first-skill.md           (new)
│
├── concepts/
│   ├── concept-guide.md         (expand existing)
│   ├── taxonomy-system.md       (new)
│   └── agentskills-io.md        (new)
│
├── dspy/
│   ├── index.md                 (new - DSPy overview & architecture)
│   ├── signatures.md            (new - all signatures)
│   ├── modules.md               (new - all modules)
│   ├── programs.md              (new - all programs)
│   └── optimization.md          (new - MIPROv2, GEPA, caching)
│
├── api/
│   ├── index.md                 (new - API overview)
│   ├── endpoints.md             (new - all REST endpoints)
│   ├── schemas.md               (new - all Pydantic schemas)
│   ├── middleware.md            (new - CORS, error handling)
│   └── jobs.md                  (new - background jobs)
│
├── cli/
│   ├── index.md                 (new - CLI overview)
│   ├── commands.md              (new - all commands)
│   ├── interactive-chat.md      (new - chat mode)
│   └── architecture.md          (new - CLI app structure)
│
├── llm/
│   ├── index.md                 (new - LLM config overview)
│   ├── providers.md             (new - all providers)
│   ├── dspy-config.md           (new - centralized config)
│   └── task-models.md           (new - task-specific models)
│
├── hitl/
│   ├── index.md                 (new - HITL overview)
│   ├── callbacks.md             (new - callback interface)
│   ├── interactions.md          (new - interaction types)
│   └── runner.md                (new - HITL runner)
│
├── development/
│   ├── CONTRIBUTING.md          (existing)
│   ├── ARCHITECTURE_DECISIONS.md (existing)
│   ├── testing.md               (new)
│   └── extending.md             (new)
│
├── reference/
│   ├── api-reference.md         (expand existing)
│   ├── cli-reference.md         (expand existing)
│   └── python-api.md            (new)
│
└── architecture/
    ├── skill-creation-workflow.md (existing)
    ├── system-architecture.md   (new)
    └── data-flow.md             (new)
```

## Content Specifications

### DSPy Documentation (`docs/dspy/`)

#### index.md - DSPy Overview
- What is DSPy and its role in skills-fleet
- 3-phase workflow architecture
- Integration with HITL
- File locations: `src/skill_fleet/core/`

#### signatures.md - All Signatures
- **Phase 1 Signatures** (`phase1_understanding.py`):
  - `RequirementGatheringSignature`
  - `IntentAnalysisSignature`
  - `TaxonomyPathFindingSignature`
  - `DependencyAnalysisSignature`
  - `PlanSynthesisSignature`
- **Phase 2 Signatures** (`phase2_generation.py`):
  - `ContentGenerationSignature`
  - `CapabilityDocumentationSignature`
  - `UsageExamplesSignature`
- **Phase 3 Signatures** (`phase3_validation.py`):
  - `ValidationSignature`
  - `RefinementSignature`
- **Chat Signatures** (`chat.py`):
  - `ChatRequestSignature`
  - `ChatResponseSignature`
- **HITL Signatures** (`hitl.py`):
  - `ConfirmationSignature`
  - `PreviewSignature`
  - `FeedbackAnalysisSignature`

Each signature documented with:
- Input/output fields
- When used in workflow
- Code examples

#### modules.md - All Modules
- **Phase 1 Orchestrator**: Parallel analysis architecture
- **Phase 2 Generator**: Content generation flow
- **Phase 3 Validator**: Validation and refinement
- **HITL Utilities**: Confirmation, preview, feedback analysis

#### programs.md - All Programs
- `SkillCreationProgram` - Main 3-phase orchestrator
- `ConversationalProgram` - Chat-based skill creation
- Program composition patterns
- HITL integration

#### optimization.md - Workflow Optimization
- MIPROv2 optimizer usage
- GEPA reflection
- Caching strategy
- Performance tuning

### API Documentation (`docs/api/`)

#### index.md - API Overview
- FastAPI application structure
- Auto-discovery system for DSPy modules
- CORS middleware
- Route organization
- API vs CLI decision guide

#### endpoints.md - REST Endpoints
**Skills routes** (`/api/v1/skills/*`):
- `POST /skills` - Create skill (async)
- `GET /skills` - List with filtering
- `GET /skills/{skill_id}` - Get details
- `PUT /skills/{skill_id}` - Update
- `DELETE /skills/{skill_id}` - Delete

**HITL routes** (`/api/v1/hitl/*`):
- `POST /hitl/confirm` - Handle confirmation
- `POST /hitl/preview` - Handle preview
- `POST /hitl/feedback` - Submit feedback

**Taxonomy routes** (`/api/v1/taxonomy/*`):
- `GET /taxonomy` - Get structure
- `GET /taxonomy/xml` - Generate XML

**Validation routes** (`/api/v1/validation/*`):
- `POST /validation/skill` - Validate skill
- `POST /validation/frontmatter` - Validate YAML

#### schemas.md - Pydantic Schemas
- Request models
- Response models
- Workflow models
- Model conversions

#### middleware.md - Middleware & Error Handling
- CORS configuration
- Exception handlers
- Error response format

#### jobs.md - Background Jobs
- Async skill creation
- Job status polling
- Webhook callbacks
- Job queue management

### CLI Documentation (`docs/cli/`)

#### index.md - CLI Overview
- Typer-based architecture
- Command groups
- Global options
- Environment variables

#### commands.md - All Commands
- **create**: Skill creation with all options
- **chat**: Interactive chat mode
- **validate**: Validation command
- **serve**: API server
- **list**: List skills with filtering
- **migrate**: agentskills.io migration
- **optimize**: Workflow optimization
- **analytics**: Usage statistics

#### interactive-chat.md - Chat Mode
- Starting chat sessions
- Chat commands
- Context management
- Streaming responses
- Chat-specific HITL

#### architecture.md - CLI Structure
- `app.py` - Main Typer app
- Command registration
- `client.py` - HTTP client
- HITL runner
- Adding new commands

### LLM Documentation (`docs/llm/`)

#### index.md - LLM Configuration
- Configuration hierarchy
- Provider architecture
- DSPy integration

#### providers.md - All Providers
- **DeepInfra**: API setup, models, config
- **Gemini**: API setup, Gemini 3 models, config
- **ZAI**: API setup, config
- **Vertex AI**: Service account, config
- Provider comparison

#### dspy-config.md - DSPy Configuration
- `configure_dspy()` function
- `get_task_lm()` function
- `DSPY_CACHEDIR` variable
- `DSPY_TEMPERATURE` variable
- Config file format

#### task-models.md - Task-Specific Models
| Task | Purpose | Model | Temperature |
|------|---------|-------|-------------|
| skill_understand | Analysis | High reasoning | 0.7 |
| skill_plan | Planning | Medium reasoning | 0.5 |
| skill_initialize | Setup | Fast model | 0.1 |
| skill_edit | Generation | Creative model | 0.6 |
| skill_package | Validation | Precise model | 0.1 |
| skill_validate | Compliance | Precise model | 0.0 |

### HITL Documentation (`docs/hitl/`)

#### index.md - HITL System
- Why HITL matters
- Interaction types
- Callback design
- Integration points

#### callbacks.md - Callback Interface
- Callback signature
- Custom callbacks
- Async/sync support
- Frontend integration

#### interactions.md - Interaction Types
- **ClarifyingQuestion**: Multi-choice and free-text
- **Confirmation**: Yes/no with details
- **Preview**: Show content for approval
- **Feedback**: Structured feedback
- Interaction flow

#### runner.md - HITL Runner
- `src/skill_fleet/cli/hitl/runner.py`
- Session management
- Response parsing
- Error handling

### Development Documentation (`docs/development/`)

#### testing.md - Testing Guide
- Unit tests with pytest
- Integration tests
- Testing DSPy modules
- Mocking LLM responses
- Coverage requirements

#### extending.md - Extending the System
- Adding new signatures
- Creating custom modules
- Adding workflow phases
- Contributing guidelines

### Reference Documentation (`docs/reference/`)

#### python-api.md - Programmatic Python API
- `TaxonomyManager` deep dive
- `SkillValidator` API
- Workflow orchestrators
- Direct DSPy program usage

## Documentation Standards

Each document must include:

1. **Frontmatter**: Title, description, last updated date
2. **Table of Contents**: Auto-generated for docs > 3 sections
3. **Code blocks**: Language-specific syntax highlighting
4. **Diagrams**: Mermaid for flows, architecture diagrams
5. **Examples**: Real, runnable code snippets
6. **Cross-references**: Links to related documentation
7. **File paths**: Always include full `src/skill_fleet/...` paths
8. **Type hints**: Show function signatures with complete type information

## Implementation Phases

### Phase 1: File Structure
Create all new documentation files with placeholder structure

### Phase 2: Core Documentation (Priority)
- `docs/dspy/` - All files
- `docs/api/` - All files
- `docs/cli/` - All files
- `docs/llm/` - All files

### Phase 3: Supporting Documentation
- `docs/hitl/` - All files
- `docs/development/` - New files
- `docs/reference/` - python-api.md

### Phase 4: Updates & Polish
- Expand existing docs
- Add cross-references
- Generate diagrams
- Final review

## Success Criteria

- [ ] All DSPy signatures, modules, programs documented
- [ ] All API endpoints documented with examples
- [ ] All CLI commands documented with examples
- [ ] All LLM providers documented
- [ ] HITL system fully documented
- [ ] Cross-references between related docs
- [ ] Code examples for all major operations
- [ ] Diagrams for complex flows
- [ ] All file paths reference `src/skill_fleet/` locations

## Related Files

- `src/skill_fleet/core/` - DSPy implementation
- `src/skill_fleet/api/` - FastAPI implementation
- `src/skill_fleet/cli/` - CLI implementation
- `src/skill_fleet/llm/` - LLM configuration
- `src/skill_fleet/workflow/` - Workflow orchestrators


============================================================
END FILE: docs/internal/plans/archive/2026-01-12-documentation-expansion.md
============================================================

============================================================
FILE: docs/internal/plans/archive/2026-01-13-cli-chat-ux.md
============================================================

# CLI Chat UX Improvements Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Upgrade `uv run skill-fleet chat` to (1) show “thinking”/rationale consistently, (2) ask clarifying questions one-at-a-time, (3) support arrow-key selection for multi-choice prompts, and (4) allow a free-text override (“Other…”) anywhere a multi-choice question is shown.

**Architecture:** Introduce a small UI abstraction (`PromptUI`) with a Prompt Toolkit-backed implementation for arrow-key selection and a Rich fallback. Refactor the HITL runner to drive a single-question loop (clarify) and unify action prompts (confirm/preview/validate) through the UI abstraction.

**Tech Stack:** Typer, Rich, prompt-toolkit, httpx.

---

## Current state (baseline)

### Files

- CLI entrypoint: `src/skill_fleet/cli/commands/chat.py`
- HITL runner loop: `src/skill_fleet/cli/hitl/runner.py`
- API prompt endpoint: `src/skill_fleet/api/routes/hitl.py`
- API skill creation job: `src/skill_fleet/api/routes/skills.py`

### Observed UX constraints

- Multi-choice prompts are currently typed (`Prompt.ask(..., choices=[...])`) rather than arrow-key navigable.
- Clarify prompts currently accept a single free-form answer string. If the server returns multiple questions, they are rendered in a single panel.
- “Thinking” is only shown for clarify via the `rationale` field (when present).

## UX requirements (target behavior)

1. **Thinking content shown**

- Display rationale / “why I’m asking” when available.
- If a prompt has no rationale, do not show an empty panel.
- Optional: add `--show-thinking/--no-show-thinking` flag to control this.

2. **One question at a time**

- For clarify prompts that contain multiple questions, present them sequentially.
- After each answer submission, the runner returns to polling until either:
  - the job requests another clarify prompt, or
  - moves to confirm/preview/validate, or
  - completes.

3. **Arrow-key multi choice**

- Use prompt-toolkit dialogs for:
  - single-choice selection (radio list)
  - multi-choice selection (checkbox list)

4. **Plain-text option**

- If a question has options, append an “Other (type my own)” option.
- If selected, open a plain text input prompt.
- When both multi-choice and free-text are supplied, include both in the answer payload.

---

## Approach options (choose one)

### Option A (recommended): prompt-toolkit dialogs + Rich fallback

- Use `prompt_toolkit.shortcuts.radiolist_dialog` / `checkboxlist_dialog` for arrow-key selection.
- Fallback to Rich `Prompt.ask` when:
  - not running in a TTY,
  - prompt-toolkit is unavailable,
  - or `$TERM` indicates limited support.

**Pros:** Best UX with minimal new dependencies (already in deps), easiest to maintain.
**Cons:** Dialog UI differs from current Rich-only styling.

### Option B: Full-screen prompt-toolkit Application

- Build a dedicated TUI view with a single input box + selectable options.

**Pros:** Most polished.
**Cons:** Highest effort; more fragile; larger test surface.

### Option C: “Rich only”

- Keep typed choices.

**Pros:** Minimal change.
**Cons:** Does not meet arrow-key requirement.

Proceed with **Option A**.

---

## Data contracts & compatibility

### Clarify questions

- Short-term: accept whatever API returns in `prompt_data["questions"]` (string OR list).
- Long-term (recommended): update the workflow to return structured questions based on `core.models.ClarifyingQuestion` (includes `options`, `allows_multiple`, `context`).

### Clarify answers

- Short-term: continue sending `{ "answers": {"response": "..."} }` to avoid changing core workflow.
  - Convert selected options into text (e.g., `"Q: <text>\nA: <selected labels>\nOther: <free text>"`).
- Long-term: support structured answers `{ "answers": [QuestionAnswer...] }` and update core workflow to consume it.

---

## Implementation tasks (bite-sized)

### Task 1: Add a Prompt UI abstraction

**Files:**

- Create: `src/skill_fleet/cli/ui/prompts.py`
- Create: `src/skill_fleet/cli/ui/__init__.py`

**Step 1: Write failing tests**

- Create: `tests/unit/test_cli_prompt_ui.py`
- Add tests for:
  - single-choice returns selected ID
  - multi-choice returns list of IDs
  - “Other…” triggers free-text capture

**Step 2: Implement minimal PromptUI protocol**

- `PromptUI.ask_text(prompt, default="") -> str`
- `PromptUI.choose_one(prompt, choices: list[tuple[id, label]], default_id=None) -> str`
- `PromptUI.choose_many(prompt, choices, default_ids=None) -> list[str]`

**Step 3: Implement PromptToolkitUI**

- Use `prompt_toolkit.shortcuts.radiolist_dialog` / `checkboxlist_dialog`.
- Use `prompt_toolkit.shortcuts.prompt` for text input.

**Step 4: Implement RichFallbackUI**

- Use `rich.prompt.Prompt.ask` with `choices=`.

**Step 5: Run tests + commit**

---

### Task 2: Refactor HITL runner to use PromptUI

**Files:**

- Modify: `src/skill_fleet/cli/hitl/runner.py`

**Step 1: Write failing tests**

- Create: `tests/unit/test_cli_hitl_runner.py`
- Use a `FakeClient` that yields a scripted sequence of prompt payloads.
- Assert:
  - For a clarify prompt with multiple questions, the runner prompts one-at-a-time but submits a single combined response payload.
  - For confirm/preview/validate prompts, the runner submits the expected action payload.

**Step 2: Add `ui: PromptUI` parameter to `run_hitl_job(...)`**

- Default to prompt-toolkit UI with fallback.

**Step 3: Implement “clarify: one question at a time”**

- Normalize `prompt_data["questions"]` to `list[object]`:
  - If string => treat as a single prompt.
  - If list => iterate.
- For each question:
  - show rationale panel (if enabled)
  - ask using UI:
    - if options exist => arrow-key selection + “Other…”
    - else => plain text
  - collect answers locally
  - post one combined HITL response after all questions are answered
  - return to polling

**Step 4: Implement arrow-key selection for confirm/preview/validate**

- Replace `Prompt.ask(... choices=...)` with `ui.choose_one(...)`.
- Keep the existing “feedback” follow-up as plain text.

**Step 5: Run tests + commit**

---

### Task 3: Add CLI flags for thinking + input mode

**Files:**

- Modify: `src/skill_fleet/cli/commands/chat.py`

**Step 1: Add flags**

- `--show-thinking/--no-show-thinking` (default: show)
- Optional: `--force-plain-text` to disable arrow-key dialogs for remote terminals/CI.

**Step 2: Thread flags into `run_hitl_job(...)`**

**Step 3: Update docs + commit**

---

### Task 4 (optional, recommended): Upgrade the workflow to return structured questions

**Goal:** Enable true multi-choice questions generated by the model.

**Files:**

- Modify: `src/skill_fleet/core/dspy/skill_creator.py`
- Modify: `src/skill_fleet/core/dspy/modules/hitl.py` (ensure ClarifyingQuestionsModule returns options reliably)
- Modify: `src/skill_fleet/api/routes/hitl.py` (pass through structured questions)

**Steps:**

- Replace ad-hoc clarify generation (`ChainOfThought("requirements, task -> questions")`) with `ClarifyingQuestionsModule` (signature: `GenerateClarifyingQuestions`).
- Ensure the prompt payload includes `questions: list[ClarifyingQuestion]` and each question may include `options`.
- CLI can then render options with arrow keys, and still permit “Other…” free text.

---

## Documentation updates

**Files:**

- Modify: `docs/cli/interactive-chat.md`

Add:

- Arrow-key selection behavior
- “Other (type my own)” behavior
- One-question-at-a-time clarify loop
- New CLI flags

---

## Validation checklist

- `uv run ruff check src/ tests/`
- `uv run pytest -q`
- Manual smoke:
  - Start server: `uv run skill-fleet serve`
  - Run chat: `uv run skill-fleet chat`
  - Verify:
    - rationale panels appear when present
    - clarify presents one question at a time
    - arrow keys work for selection
    - “Other…” lets you type free text

---

## Rollout strategy

1. Land PromptUI + runner refactor first (no API schema changes required).
2. Then optionally upgrade the workflow to emit structured questions for best UX.
3. Keep Rich fallback forever (non-TTY support).


============================================================
END FILE: docs/internal/plans/archive/2026-01-13-cli-chat-ux.md
============================================================

============================================================
FILE: docs/internal/plans/archive/2026-01-15-api-first-evolution-plan.md
============================================================

# API-First Evolution Plan for Skill Fleet

> **Created:** 2026-01-15  
> **Status:** Draft  
> **Goal:** Transform Skill Fleet from a tool with an API into a service-oriented platform

---

## Executive Summary

**Goal:** Transform Skill Fleet from a tool with an API into a **service-oriented platform** where the CLI, web UI, and external agents interact through a robust, typed API interface.

**Current State:** The CLI contains interaction logic (e.g., `_normalize_questions` in `runner.py`) that should reside on the server. Jobs are stored in-memory, and the UI spawns CLI processes instead of calling the API directly.

**Target State:** The FastAPI server is the single source of truth. CLI and UI are thin clients consuming structured, typed endpoints.

---

## Phase 1: Schema Unification & Dependency Injection

**Duration:** 1-2 weeks  
**Priority:** High (Foundation)

### Objectives

1. Create a unified schema package shared between server and CLI
2. Implement FastAPI dependency injection for core services
3. Centralize security and path utilities

### Tasks

| Task | File(s)                               | Description                                                                                                             |
|------|---------------------------------------|-------------------------------------------------------------------------------------------------------------------------|
| 1.1  | `src/skill_fleet/api/schemas/`        | Consolidate all Pydantic models from `api/schemas/models.py` and `core/models.py` into a unified package                |
| 1.2  | `src/skill_fleet/api/schemas/hitl.py` | Create discriminated union types for HITL prompts (`ClarifyPrompt`, `ConfirmPrompt`, `PreviewPrompt`, `ValidatePrompt`) |
| 1.3  | `src/skill_fleet/api/dependencies.py` | Create `get_taxonomy_manager()`, `get_skills_root()` dependencies                                                       |
| 1.4  | `src/skill_fleet/common/security.py`  | Move `_sanitize_taxonomy_path` from `routes/skills.py` to shared utility                                                |
| 1.5  | `src/skill_fleet/common/paths.py`     | Centralize template discovery logic                                                                                     |

### Success Criteria

- [ ] All API routes use `Depends()` for `TaxonomyManager` and `SKILLS_ROOT`
- [ ] CLI imports schemas from `skill_fleet.api.schemas` (not duplicated)
- [ ] Swagger UI (`/docs`) shows typed HITL prompt/response models
- [ ] All path sanitization uses the centralized `security.py` module
- [ ] Unit tests pass with mocked dependencies

### Code Example: Discriminated Union for HITL

```python
# src/skill_fleet/api/schemas/hitl.py
from typing import Literal, Union
from pydantic import BaseModel, Field

