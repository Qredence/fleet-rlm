<!-- Chunk 1951: bytes 7807488-7811486, type=function -->
def register_skill(
    skills_root: Path,
    path: str,
    metadata: dict[str, Any],
    content: str,
    evolution: dict[str, Any],
    extra_files: dict[str, Any] | None = None,
    overwrite: bool = False,
) -> SkillMetadata:
    """
    Register a new skill in the taxonomy.

    Creates an agentskills.io compliant skill with YAML frontmatter in SKILL.md
    and extended metadata in metadata.json.

    Args:
        skills_root: Root directory of the taxonomy
        path: Taxonomy path for the skill
        metadata: Skill metadata dictionary
        content: SKILL.md content (markdown)
        evolution: Evolution/tracking metadata
        extra_files: Optional dict of additional files to create
        overwrite: Whether to overwrite existing skill

    Returns:
        SkillMetadata object for the registered skill

    Raises:
        ValueError: If path is invalid or skill exists and overwrite=False

    """
    import re

    safe_path = sanitize_taxonomy_path(path)
    if safe_path is None:
        raise ValueError(f"Invalid taxonomy path: {path}")

    skill_dir = resolve_path_within_root(skills_root, safe_path)
    if (skill_dir / "metadata.json").exists() and not overwrite:
        raise ValueError(f"Skill already exists at {path}")
    skill_dir.mkdir(parents=True, exist_ok=True)

    now = datetime.now(tz=UTC).isoformat()

    # Ensure skill_id is set
    metadata.setdefault("skill_id", safe_path)
    skill_id = metadata["skill_id"]

    # Ensure metadata.json contains required taxonomy fields
    metadata.setdefault("version", "1.0.0")
    metadata.setdefault("type", "technical")
    metadata.setdefault("weight", "medium")
    metadata.setdefault("load_priority", "on_demand")

    if not isinstance(metadata.get("dependencies"), list):
        metadata["dependencies"] = []
    if not isinstance(metadata.get("capabilities"), list):
        metadata["capabilities"] = []
    if not isinstance(metadata.get("tags"), list):
        metadata["tags"] = []
    if not metadata.get("category") and "/" in path:
        metadata["category"] = "/".join(path.split("/")[:-1])

    # Generate agentskills.io compliant name
    name = metadata.get("name") or skill_id_to_name(skill_id)
    metadata["name"] = name

    # Ensure description exists
    description = metadata.get("description", "")
    if not description:
        # Try to extract from content if it looks like markdown
        first_para = content.split("\n\n")[0] if content else ""
        # Strip markdown headers
        description = re.sub(r"^#.*\n?", "", first_para).strip()[:1024]
        metadata["description"] = description

    metadata["created_at"] = metadata.get("created_at", now)
    metadata["last_modified"] = now
    metadata["evolution"] = evolution

    # Write extended metadata to metadata.json
    metadata_path = skill_dir / "metadata.json"
    metadata_path.write_text(json.dumps(metadata, indent=2) + "\n", encoding="utf-8")

    # Generate SKILL.md with agentskills.io compliant YAML frontmatter
    skill_md_content = generate_skill_md_with_frontmatter(
        name=name,
        description=description,
        metadata=metadata,
        content=content,
    )
    (skill_dir / "SKILL.md").write_text(skill_md_content, encoding="utf-8")

    # Populate extra files if provided
    if extra_files:
        write_extra_files(skill_dir, extra_files)

    # Create SkillMetadata object
    skill_metadata = SkillMetadata(
        skill_id=skill_id,
        version=metadata.get("version", "1.0.0"),
        type=metadata.get("type", "technical"),
        weight=metadata.get("weight", "medium"),
        load_priority=metadata.get("load_priority", "on_demand"),
        dependencies=list(metadata.get("dependencies", [])),
        capabilities=list(metadata.get("capabilities", [])),
        path=metadata_path,
        always_loaded=bool(metadata.get("always_loaded", False)),
        name=name,
        description=description,
    )

    return skill_metadata


