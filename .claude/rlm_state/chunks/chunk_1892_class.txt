<!-- Chunk 1892: bytes 7697031-7700101, type=class -->
class TaxonomyRepository(BaseRepository[TaxonomyCategory]):
    """Repository for TaxonomyCategory entity."""

    def __init__(self, db: Session):
        """
        Initialize the taxonomy repository.

        Args:
            db: The database session.

        """
        super().__init__(TaxonomyCategory, db)

    def get_by_path(self, path: str) -> TaxonomyCategory | None:
        """Get a category by its path."""
        return self.db.query(TaxonomyCategory).filter(TaxonomyCategory.path == path).first()

    def get_tree(self, root_path: str | None = None) -> list[dict]:
        """
        Get the taxonomy tree structure.

        Args:
            root_path: Optional path to start from (defaults to root level)

        """
        if root_path:
            root = self.get_by_path(root_path)
            if not root:
                return []
            query = self.db.query(TaxonomyCategory).filter(
                TaxonomyCategory.parent_id == root.category_id
            )
        else:
            query = self.db.query(TaxonomyCategory).filter(TaxonomyCategory.parent_id.is_(None))

        categories = query.order_by(TaxonomyCategory.sort_order).all()

        result = []
        for cat in categories:
            result.append(
                {
                    "category_id": cat.category_id,
                    "path": cat.path,
                    "name": cat.name,
                    "description": cat.description,
                    "level": cat.level,
                    "children": self._get_children(cat.category_id),
                }
            )

        return result

    def _get_children(self, parent_id: int) -> list[dict]:
        """Recursively get child categories."""
        children = (
            self.db.query(TaxonomyCategory)
            .filter(TaxonomyCategory.parent_id == parent_id)
            .order_by(TaxonomyCategory.sort_order)
            .all()
        )

        result = []
        for cat in children:
            result.append(
                {
                    "category_id": cat.category_id,
                    "path": cat.path,
                    "name": cat.name,
                    "description": cat.description,
                    "level": cat.level,
                    "children": self._get_children(cat.category_id),
                }
            )

        return result

    def get_skills_in_category(self, category_id: int) -> list[Skill]:
        """Get all skills in a category (including subcategories)."""
        # Get all descendant category IDs using closure table

        descendant_ids = (
            self.db.query(TaxonomyClosure.descendant_id)
            .filter(TaxonomyClosure.ancestor_id == category_id)
            .all()
        )
        category_ids = [cat_id for (cat_id,) in descendant_ids]

        # Get skills in these categories
        skills = (
            self.db.query(Skill)
            .join(SkillCategory)
            .filter(SkillCategory.category_id.in_(category_ids))
            .all()
        )

        return skills


