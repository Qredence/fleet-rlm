<!-- Chunk 1888: bytes 7678530-7683879, type=class -->
class ConversationSession(Base):
    """
    Database-backed conversation session storage.

    Replaces the in-memory _sessions dict in conversational router.
    Persists conversation state across server restarts.
    """

    __tablename__ = "conversation_sessions"

    # Primary key
    session_id: Mapped[UUID] = mapped_column(
        primary_key=True, server_default=func.gen_random_uuid()
    )

    # User context
    user_id: Mapped[str] = mapped_column(String(128), nullable=False, default="default")

    # Workflow state
    state: Mapped[str] = mapped_column(
        Enum(
            ConversationStateEnum.EXPLORING,
            ConversationStateEnum.DEEP_UNDERSTANDING,
            ConversationStateEnum.MULTI_SKILL_DETECTED,
            ConversationStateEnum.CONFIRMING,
            ConversationStateEnum.READY,
            ConversationStateEnum.CREATING,
            ConversationStateEnum.TDD_RED_PHASE,
            ConversationStateEnum.TDD_GREEN_PHASE,
            ConversationStateEnum.TDD_REFACTOR_PHASE,
            ConversationStateEnum.REVIEWING,
            ConversationStateEnum.REVISING,
            ConversationStateEnum.CHECKLIST_COMPLETE,
            ConversationStateEnum.COMPLETE,
            name="conversation_state_enum",
            create_constraint=True,
        ),
        nullable=False,
        default=ConversationStateEnum.EXPLORING,
    )
    task_description: Mapped[str | None] = mapped_column(Text, nullable=True)
    taxonomy_path: Mapped[str | None] = mapped_column(String(512), nullable=True)

    # Multi-skill support
    multi_skill_queue: Mapped[list[str] | None] = mapped_column(
        ARRAY(String), server_default=text("'{}'"), nullable=True
    )
    current_skill_index: Mapped[int] = mapped_column(Integer, default=0)

    # Conversation data (JSONB for flexibility)
    messages: Mapped[list] = mapped_column(JSONB, server_default=text("'[]'::jsonb"))
    collected_examples: Mapped[list] = mapped_column(JSONB, server_default=text("'[]'::jsonb"))

    # Draft data
    skill_draft: Mapped[dict | None] = mapped_column(JSONB, nullable=True)
    skill_metadata_draft: Mapped[dict | None] = mapped_column(JSONB, nullable=True)

    # TDD workflow
    checklist_state: Mapped[dict] = mapped_column(JSONB, server_default=text("'{}'::jsonb"))

    # Pending confirmations
    pending_confirmation: Mapped[dict | None] = mapped_column(JSONB, nullable=True)

    # Deep understanding phase
    deep_understanding: Mapped[dict | None] = mapped_column(JSONB, nullable=True)
    current_understanding: Mapped[str | None] = mapped_column(Text, nullable=True)

    # User problem/goals
    user_problem: Mapped[str | None] = mapped_column(Text, nullable=True)
    user_goals: Mapped[list[str] | None] = mapped_column(ARRAY(String), nullable=True)

    # Research context
    research_context: Mapped[dict | None] = mapped_column(JSONB, nullable=True)

    # Session metadata
    session_metadata: Mapped[dict] = mapped_column(JSONB, server_default=text("'{}'::jsonb"))

    # Timestamps
    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False, server_default=func.now()
    )
    updated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False, server_default=func.now(), onupdate=func.now()
    )
    last_activity_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False, server_default=func.now()
    )
    expires_at: Mapped[datetime | None] = mapped_column(DateTime(timezone=True), nullable=True)

    # Optional job association
    job_id: Mapped[UUID | None] = mapped_column(
        ForeignKey("jobs.job_id", ondelete="SET NULL"), nullable=True
    )

    __table_args__ = (
        Index("idx_sessions_user", "user_id"),
        Index("idx_sessions_state", "state"),
        Index("idx_sessions_created_at", "created_at"),
        Index("idx_sessions_last_activity", "last_activity_at"),
        Index("idx_sessions_expires_at", "expires_at"),
        Index("idx_sessions_job", "job_id"),
    )

    def __repr__(self) -> str:
        """
        Return a string representation of the ConversationSession.

        Returns:
            A string with session_id and state.

        """
        return f"<ConversationSession(session_id={self.session_id}, state='{self.state}')>"


============================================================
END FILE: src/skill_fleet/infrastructure/db/models.py
============================================================

============================================================
FILE: src/skill_fleet/infrastructure/db/repositories.py
============================================================

"""
Skills-Fleet Database Repositories.

Repository layer for common CRUD operations on skills fleet entities.
"""

from datetime import UTC, datetime
from typing import Any, Generic, TypeVar

from sqlalchemy import asc, desc
from sqlalchemy.orm import Session, joinedload

from .models import (
    Capability,
    ConversationSession,
    ConversationStateEnum,
    HITLInteraction,
    Job,
    Skill,
    SkillAllowedTool,
    SkillCategory,
    SkillDependency,
    SkillKeyword,
    SkillStatusEnum,
    SkillTag,
    TaxonomyCategory,
    TaxonomyClosure,
    UsageEvent,
    ValidationReport,
)

ModelType = TypeVar("ModelType", bound=Any)


