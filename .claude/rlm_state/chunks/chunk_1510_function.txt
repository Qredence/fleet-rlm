<!-- Chunk 1510: bytes 6360859-6363761, type=function -->
def _dict_to_structured_question(data: dict[str, Any]) -> StructuredQuestion:
    """
    Convert a dictionary to a StructuredQuestion.

    Handles various dict formats that may come from DSPy modules:
    - {"question": "...", "rationale": "..."}
    - {"text": "...", "options": [...]}
    - {"q": "..."}
    - {"question_type": "boolean|single|multi|text"}
    """
    # Extract question text from various possible keys
    text = data.get("text") or data.get("question") or data.get("q") or str(data)

    # Determine question type
    raw_type = data.get("question_type", "text")
    try:
        question_type = QuestionType(raw_type)
    except ValueError:
        question_type = QuestionType.FREE_TEXT

    # Extract options if present
    options: list[QuestionOption] | None = None
    raw_options = data.get("options")
    if isinstance(raw_options, list) and raw_options:
        options = []
        for opt in raw_options:
            if isinstance(opt, dict):
                opt_id = str(opt.get("id") or opt.get("value") or "")
                label = str(opt.get("label") or opt.get("text") or opt_id)
                desc = opt.get("description")
                if opt_id:
                    options.append(
                        QuestionOption(
                            id=opt_id,
                            label=label,
                            description=str(desc) if desc else None,
                        )
                    )
            elif isinstance(opt, str):
                options.append(QuestionOption(id=opt, label=opt))

    return StructuredQuestion(
        text=text,
        question_type=question_type,
        options=options if options else None,
        allows_multiple=bool(data.get("allows_multiple", True)),  # Default to multi-select
        allows_other=bool(data.get("allows_other", True)),  # Default to allow custom text
        rationale=data.get("rationale"),
    )


__all__ = [
    "QuestionType",
    "QuestionOption",
    "StructuredQuestion",
    "normalize_questions",
]


============================================================
END FILE: src/skill_fleet/api/schemas/hitl.py
============================================================

============================================================
FILE: src/skill_fleet/api/schemas/models.py
============================================================

"""
Pydantic schemas for API models.

Following FastAPI best practices and codebase patterns (see core/models.py),
all Pydantic models for request/response validation are defined in this module.
This keeps models separate from business logic and route handlers.
"""

from __future__ import annotations

import asyncio
from datetime import UTC, datetime
from typing import Any

from pydantic import BaseModel, ConfigDict, Field, field_serializer, model_validator

from skill_fleet.core.models import ChecklistState


