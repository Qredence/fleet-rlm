<!-- Chunk 712: bytes 1414047-1422706, type=function -->
def run_understanding(job_id):
    # Fetch
    with transactional_session() as db:
        job = JobRepository(db).get_by_id(job_id)
        description = job.description
    
    # LLM (no DB connection)
    questions = llm.generate_questions(description)
    
    # Save
    with transactional_session() as db:
        JobRepository(db).add_hitl_interaction(job_id, "clarify", {"questions": questions})
```

#### Step 3: Refactor Repository Layer (Day 4)

**File**: `src/skill_fleet/infrastructure/db/repositories.py`

**Tasks**:
- [ ] Remove long-running operations from repository methods
- [ ] Ensure all repository methods complete quickly (<1s)
- [ ] Add `@transactional` decorator for atomic operations
- [ ] Update `BaseRepository` to support external session injection

#### Step 4: Add Connection Monitoring (Day 5)

**Tasks**:
- [ ] Add SQLAlchemy event listeners to log long-running transactions
- [ ] Create health check endpoint to verify connection pool status
- [ ] Add metrics: active connections, idle connections, checkout time
- [ ] Set up alerts for connection pool exhaustion

#### Step 5: Testing & Validation (Day 6)

**Tasks**:
- [ ] Run skill creation workflow with 2-minute LLM delays
- [ ] Monitor PostgreSQL logs for idle transaction timeouts
- [ ] Verify connection pool stays healthy under load
- [ ] Test concurrent workflow executions (10+ jobs)
- [ ] Measure and document connection pool performance

### 4.4 Database Configuration Changes

**Update `database.py` connection pool settings**:
```python
engine = create_engine(
    DATABASE_URL,
    pool_size=20,              # Increase from default 5
    max_overflow=30,           # Allow burst capacity
    pool_pre_ping=True,        # Verify connections before use
    pool_recycle=300,          # Recycle after 5 minutes
    pool_timeout=30,           # Wait up to 30s for connection
    connect_args={
        "connect_timeout": 10,
        "options": "-c idle_in_transaction_session_timeout=60000"  # 60s timeout
    }
)
```

### 4.5 Success Criteria

- [ ] No `IdleInTransactionSessionTimeout` errors in logs
- [ ] Workflow completes successfully with 2-minute LLM delays
- [ ] Connection pool stays below 50% utilization under normal load
- [ ] 99th percentile connection checkout time <100ms
- [ ] All existing tests pass

### 4.6 Files to Modify

| File | Changes |
|------|---------|
| `infrastructure/db/session.py` | Create new session management module |
| `infrastructure/db/database.py` | Update connection pool configuration |
| `infrastructure/db/repositories.py` | Refactor for short transactions |
| `core/workflows/skill_creation/understanding.py` | Extract DB ops from LLM calls |
| `core/workflows/skill_creation/generation.py` | Extract DB ops from LLM calls |
| `core/workflows/skill_creation/validation.py` | Extract DB ops from LLM calls |
| `api/health.py` | Add connection pool health check endpoint |

---

## Phase 5: Full HITL Integration (Pending)

**Status**: Infrastructure in place, comprehensive testing needed

**Goal**: Verify complete HITL (Human-in-the-Loop) workflow from understanding through validation phases.

### 5.1 Current Implementation Status

**Completed**:
- ✅ HITL API endpoints (`api/v1/hitl.py`)
- ✅ Frontend HITL components (`create-skill-workflow.tsx`)
- ✅ HITL database models (`HITLInteraction`)
- ✅ Basic question/answer flow
- ✅ Skill preview rendering

**Pending Verification**:
- ⏳ Question answering flow (multiple questions)
- ⏳ Skill preview approval
- ⏳ Skill preview revision requests
- ⏳ Validation failure recovery
- ⏳ Promote to taxonomy flow

### 5.2 Test Scenarios

#### Scenario A: Multi-Question Clarification Flow

**Setup**: Create skill with ambiguous requirements triggering multiple clarification questions

**Test Steps**:
1. [ ] Submit skill creation: "Create a skill for handling user data"
2. [ ] Verify job enters `understanding` phase
3. [ ] Wait for `pending_hitl` status
4. [ ] Verify HITL prompt contains 2-3 clarifying questions
5. [ ] Submit partial answers (only answer first question)
6. [ ] Verify validation error or prompt re-presentation
7. [ ] Submit complete answers to all questions
8. [ ] Verify job resumes to `generation` phase
9. [ ] Verify understanding summary saved to job result

**Expected Flow**:
```
Job: pending → understanding → pending_hitl → running → generation → ...
HITL: clarify questions presented → answers submitted → workflow resumes
```

**Files to verify**:
- `core/modules/hitl/questions.py`
- `core/workflows/skill_creation/understanding.py` (lines 50-80)
- `api/v1/hitl.py` response handling (lines 184-261)

#### Scenario B: Skill Preview Approval Flow

**Setup**: Skill generation completes successfully, ready for user review

**Test Steps**:
1. [ ] Complete understanding phase (answer all questions)
2. [ ] Wait for generation phase to complete
3. [ ] Verify job enters `pending_hitl` with `hitl_type: "preview"`
4. [ ] Verify HITL prompt contains generated skill content
5. [ ] Verify skill content renders correctly with syntax highlighting
6. [ ] Click "Approve" button (action: "proceed")
7. [ ] Verify job enters `validation` phase
8. [ ] Verify skill saved to draft path

**Expected UI State**:
- Preview shows formatted SKILL.md content
- Action buttons: "Approve" (proceed), "Revise" (revise), "Cancel" (cancel)
- Highlights key sections of the skill

**Files to verify**:
- `frontend/fleetui/app/create/[jobId]/create-skill-workflow.tsx` (lines 276-310)
- `core/workflows/skill_creation/generation.py` preview checkpoint
- `api/v1/hitl.py` action keyword handling

#### Scenario C: Skill Preview Revision Flow

**Setup**: User requests changes to generated skill

**Test Steps**:
1. [ ] Complete Scenario B through step 5
2. [ ] Click "Revise" button with feedback: "Add more examples to the Quick Start section"
3. [ ] Verify job status returns to `generation`
4. [ ] Verify revision feedback saved to job context
5. [ ] Wait for regeneration to complete
6. [ ] Verify updated skill content includes requested changes
7. [ ] Verify job re-enters `pending_hitl` for re-review
8. [ ] Approve revised skill

**Expected Behavior**:
- Revision feedback passed to generation module
- Regeneration preserves structure, updates content
- Job loops through generation → preview until approved or cancelled

**Files to verify**:
- `core/workflows/skill_creation/generation.py` revision handling
- `core/modules/generation/refinement.py` (if exists)
- Job state preservation between revisions

#### Scenario D: Validation Failure Recovery Flow

**Setup**: Skill fails validation but is recoverable

**Test Steps**:
1. [ ] Create skill intentionally missing required frontmatter field
2. [ ] Complete understanding and generation phases
3. [ ] Approve skill preview
4. [ ] Wait for validation phase
5. [ ] Verify validation catches missing field
6. [ ] Verify job enters `pending_review` (or `pending_hitl` with `hitl_type: "validate"`)
7. [ ] Verify validation report shown with specific errors
8. [ ] Click "Fix Issues" (action: "revise")
9. [ ] Verify job returns to generation with validation feedback
10. [ ] Fix issues, regenerate, validate again
11. [ ] Verify skill now passes validation

**Expected States**:
```
pending → understanding → generation → pending_hitl (preview) → 
validation → pending_review → generation (with fixes) → 
validation → completed
```

**Files to verify**:
- `core/workflows/skill_creation/validation.py`
- Frontend validation results display (lines 330-380)
- Validation report → generation feedback loop

#### Scenario E: Promote to Taxonomy Flow

**Setup**: Validated skill ready for promotion from draft to taxonomy

**Test Steps**:
1. [ ] Complete Scenario A through D successfully
2. [ ] Verify job status is `completed` (or `pending_review` with `passed: true`)
3. [ ] Verify "Promote to Taxonomy" action available
4. [ ] Click "Promote" button
5. [ ] Verify skill moved from `_drafts/` to taxonomy location
6. [ ] Verify skill published in taxonomy
7. [ ] Verify job updated with `promoted: true` and `final_path`
8. [ ] Verify skill appears in taxonomy listing

**Expected Data Changes**:
- Skill file moved: `skills/_drafts/my-skill/` → `skills/python/my-skill/`
- Database: `Skill.status` changes from `draft` to `active`
- Job: `promoted=true`, `final_path` populated

**Files to verify**:
- `api/services/skill_service.py` promote method
- `taxonomy/manager.py` skill promotion logic
- File system operations for skill move

### 5.3 Test Automation

**Create integration test suite**:

**File**: `tests/integration/test_hitl_workflows.py`

```python
@pytest.mark.integration
@pytest.mark.slow
