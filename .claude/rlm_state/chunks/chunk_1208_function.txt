<!-- Chunk 1208: bytes 4554379-4557510, type=function -->
def apply_migration() -> None:
    """Apply the database migration using SQLAlchemy."""
    print("Connecting to database...")
    # Extract host info for display
    if "@" in DATABASE_URL:
        host = DATABASE_URL.split("@")[1].split("/")[0]
        print(f"Host: {host}")

    # Read migration script
    print("\nüìÑ Reading migration script...")
    migration_sql = read_migration_script()
    print(f"   Loaded ({len(migration_sql)} characters)")

    # Split into statements
    print("\nüîç Parsing SQL statements...")
    statements = split_sql_script(migration_sql)
    print(f"   Found {len(statements)} statements")

    # Create engine
    engine = create_engine(DATABASE_URL)

    # Apply migration
    print("\nüöÄ Applying migration...")
    success_count = 0
    error_count = 0

    try:
        with engine.begin() as conn:
            for i, statement in enumerate(statements, 1):
                if not statement.strip() or statement.strip().startswith("--"):
                    continue

                try:
                    conn.execute(text(statement))
                    success_count += 1

                    # Progress indicator
                    if i % 10 == 0:
                        print(f"   Progress: {i}/{len(statements)} statements executed")

                except Exception as e:
                    error_count += 1
                    # Show first few errors
                    if error_count <= 3:
                        print(f"   ‚ö†Ô∏è  Statement {i} failed: {e}")
                        print(f"   Statement preview: {statement[:100]}...")

        print("\n‚úÖ Migration completed!")
        print("\nüìä Results:")
        print(f"   - {success_count} statements executed successfully")
        if error_count > 0:
            print(f"   - {error_count} statements failed (may be expected if objects exist)")

        # Verify what was created
        print("\nüîç Verifying created objects...")
        with engine.begin() as conn:
            # Check tables
            result = conn.execute(
                text("""
                SELECT COUNT(*) FROM information_schema.tables
                WHERE table_schema = 'public' AND table_type = 'BASE TABLE'
            """)
            )
            table_count = result.scalar()

            # Check enums
            result = conn.execute(
                text("""
                SELECT COUNT(*) FROM pg_type WHERE typtype = 'e'
            """)
            )
            enum_count = result.scalar()

            # Check views
            result = conn.execute(
                text("""
                SELECT COUNT(*) FROM information_schema.views
                WHERE table_schema = 'public'
            """)
            )
            view_count = result.scalar()

        print("\nüìã Database Objects:")
        print(f"   - {table_count} tables")
        print(f"   - {enum_count} enum types")
        print(f"   - {view_count} views")

    except Exception as e:
        print(f"\n‚ùå Migration failed: {e}")
        import traceback

        traceback.print_exc()
        sys.exit(1)
    finally:
        engine.dispose()


