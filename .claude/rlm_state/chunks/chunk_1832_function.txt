<!-- Chunk 1832: bytes 7589971-7592044, type=function -->
def _parse_search_response(response, max_results: int) -> list[dict[str, Any]]:
    """
    Parse Gemini search response to extract structured results.

    Args:
        response: Gemini API response object
        max_results: Maximum number of results to extract

    Returns:
        List of result dicts with {url, title, snippet}

    """
    results = []

    try:
        # Extract grounding metadata from response
        # Response structure depends on Gemini API version
        # Check for grounding metadata
        if hasattr(response, "grounding_metadata"):
            grounding = response.grounding_metadata
            if hasattr(grounding, "grounding_chunks"):
                for chunk in grounding.grounding_chunks[:max_results]:
                    result = {}
                    if hasattr(chunk, "web"):
                        web = chunk.web
                        result["url"] = getattr(web, "uri", "")
                        result["title"] = getattr(web, "title", "")
                    # Try to extract snippet from response text
                    result["snippet"] = ""
                    results.append(result)

        # Also parse from response text if available
        text = None
        if hasattr(response, "text"):
            try:
                text = response.text
            except Exception:
                # If accessing .text fails (e.g., streaming response), skip
                pass

        if text and not results:
            # Extract URLs and content (basic parsing)
            # More sophisticated parsing can be added based on actual API response format
            # If no results from grounding metadata, create a simple result from text
            results.append(
                {
                    "url": "",
                    "title": "Search results summary",
                    "snippet": text[:500] if len(text) > 500 else text,
                }
            )

    except Exception as e:
        logger.warning(f"Failed to parse search response: {e}")

    return results[:max_results]


