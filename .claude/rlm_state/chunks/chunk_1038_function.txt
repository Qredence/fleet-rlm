<!-- Chunk 1038: bytes 3730029-3731277, type=function -->
def configure_dspy(
    config_path: Path | None = None,
    default_task: str = "skill_understand",
) -> dspy.LM:
    """Configure DSPy with fleet config and return default LM.

    This should be called once at application startup to set up
    DSPy's global settings.

    Args:
        config_path: Path to config/config.yaml (default: project root)
        default_task: Default task to use for dspy.settings.lm

    Returns:
        The configured LM instance (also set as dspy.settings.lm)
    """
    if config_path is None:
        # Default to config/config.yaml in project root
        config_path = Path(__file__).parent.parent.parent / "config" / "config.yaml"

    config = load_fleet_config(config_path)
    lm = build_lm_for_task(config, default_task)

    # Set DSPy global settings
    dspy.configure(lm=lm)

    # Set cache directory from environment if specified
    if cache_dir := os.environ.get("DSPY_CACHEDIR"):
        dspy.settings.configure(cache_dir=Path(cache_dir))

    # Set temperature override if specified
    if temp_str := os.environ.get("DSPY_TEMPERATURE"):
        try:
            temp = float(temp_str)
            lm.kwargs["temperature"] = temp
        except ValueError:
            pass

    return lm


