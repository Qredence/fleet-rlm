<!-- Chunk 2043: bytes 7942260-7944935, type=class -->
class TestCrashRecovery:
    """Test crash recovery scenarios."""

    def test_recover_from_mid_job_crash(self):
        """Test recovery when job is in progress at crash."""
        manager = JobManager()

        job_id = "crash-recovery-1"
        job = JobState(
            job_id=job_id,
            status="running",
            progress_message="Creating content...",
        )
        manager.create_job(job)

        # Job is in memory before "crash"
        assert manager.memory.get(job_id) is not None

        # Simulate crash: clear memory
        manager.memory.clear()
        assert manager.memory.get(job_id) is None

    @patch("skill_fleet.api.services.job_manager.JobRepository")
    @patch("skill_fleet.api.services.job_manager.transactional_session")
    def test_recover_partial_updates(self, mock_session, mock_repo_cls):
        """Test that partially saved updates are recovered."""
        manager = JobManager()
        manager.enable_persistence()

        job_id = "partial-recovery"
        job = JobState(job_id=job_id, status="pending")
        manager.create_job(job)

        # Partial update
        manager.update_job(job_id, {"status": "running"})

        # Crash: clear memory
        manager.memory.clear()

        # Recover
        recovered = manager.memory.get(job_id)
        assert recovered is None  # Was cleared, but would be in DB (if we fetched it)

    @patch("skill_fleet.api.services.job_manager.JobRepository")
    @patch("skill_fleet.api.services.job_manager.transactional_session")
    def test_memory_cache_warms_on_db_hit(self, mock_session, mock_repo_cls):
        """Test that memory cache is warmed when jobs are retrieved from DB."""
        manager = JobManager()
        manager.enable_persistence()

        job_id = str(uuid4())
        
        # Setup mock DB return
        mock_db_job = Mock()
        mock_db_job.job_id = UUID(job_id)
        mock_db_job.status = "running"
        mock_db_job.error = None
        mock_db_job.result = None
        mock_db_job.updated_at = datetime.now(UTC)
        
        mock_repo_instance = mock_repo_cls.return_value
        mock_repo_instance.get_by_id.return_value = mock_db_job

        # Create and persist (just to simulate flow)
        job = JobState(job_id=job_id, status="running")
        manager.create_job(job)

        # Simulate resume: clear memory
        manager.memory.delete(job_id)
        assert manager.memory.get(job_id) is None

        # Get from DB
        manager.get_job(job_id)

        # Now should be in memory
        in_memory = manager.memory.get(job_id)
        if in_memory:
            assert in_memory.job_id == job_id


