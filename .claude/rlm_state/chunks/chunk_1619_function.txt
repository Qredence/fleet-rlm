<!-- Chunk 1619: bytes 6649609-6655838, type=function -->
def get_default_ui(*, force_plain_text: bool = False) -> PromptUI:
    """Return the best available UI implementation for this environment."""
    env_force_plain = os.environ.get("SKILL_FLEET_FORCE_PLAIN_TEXT", "").strip().lower() in {
        "1",
        "true",
        "yes",
        "on",
    }
    if force_plain_text or env_force_plain:
        return RichFallbackUI()

    # Non-interactive environments (CI, pipes) should never attempt PT dialogs.
    if not (sys.stdin.isatty() and sys.stdout.isatty()):
        return RichFallbackUI()

    try:
        import prompt_toolkit  # noqa: F401

        return PromptToolkitUI()
    except ImportError:
        logger.debug("prompt_toolkit not available, using Rich fallback")
        return RichFallbackUI()
    except Exception as e:
        logger.warning(f"prompt_toolkit import failed unexpectedly: {e}")
        return RichFallbackUI()


async def choose_one_with_other(
    ui: PromptUI,
    prompt: str,
    choices: list[tuple[str, str]],
    *,
    default_id: str | None = None,
    other_label: str = "Other (type my own)",
    other_prompt: str = "Type your answer",
) -> tuple[list[str], str]:
    """
    Choose one option or provide free text.

    Returns:
        (selected_ids, free_text)
    """
    extended = list(choices) + [(OTHER_OPTION_ID, other_label)]
    selected = await ui.choose_one(prompt, extended, default_id=default_id)
    if selected == OTHER_OPTION_ID:
        return ([], await ui.ask_text(other_prompt, default=""))
    return ([selected] if selected else [], "")


async def choose_many_with_other(
    ui: PromptUI,
    prompt: str,
    choices: list[tuple[str, str]],
    *,
    default_ids: list[str] | None = None,
    other_label: str = "Other (type my own)",
    other_prompt: str = "Type your answer",
) -> tuple[list[str], str]:
    """
    Choose many options and optionally provide free text.

    Returns:
        (selected_ids, free_text)
    """
    extended = list(choices) + [(OTHER_OPTION_ID, other_label)]
    selected = await ui.choose_many(prompt, extended, default_ids=default_ids)
    free_text = ""
    if OTHER_OPTION_ID in selected:
        selected = [s for s in selected if s != OTHER_OPTION_ID]
        free_text = await ui.ask_text(other_prompt, default="")
    return (selected, free_text)


============================================================
END FILE: src/skill_fleet/cli/ui/prompts.py
============================================================

============================================================
FILE: src/skill_fleet/cli/utils/__init__.py
============================================================

"""CLI utilities submodule."""

from .constants import (
    COLOR_ERROR,
    COLOR_INFO,
    COLOR_MUTED,
    COLOR_SUCCESS,
    COLOR_WARNING,
    CONSOLE_REFRESH_RATE,
    DEFAULT_API_TIMEOUT,
    DEFAULT_API_URL,
    EXIT_CONFIG_ERROR,
    EXIT_ERROR,
    EXIT_NETWORK_ERROR,
    EXIT_SUCCESS,
    EXIT_VALIDATION_ERROR,
    HITL_POLL_INTERVAL,
    ICON_ERROR,
    ICON_INFO,
    ICON_SUCCESS,
    ICON_WARNING,
    ICON_WORKING,
    JSON_INDENT,
    MAX_API_TIMEOUT,
    MAX_POLL_ATTEMPTS,
    MAX_USER_ID_LENGTH,
    MIN_API_TIMEOUT,
    MIN_USER_ID_LENGTH,
    SEPARATOR_WIDTH,
)
from .security import (
    sanitize_user_id,
    validate_api_url,
    validate_path_within_root,
    validate_timeout,
)

__all__ = [
    # Constants - API
    "DEFAULT_API_URL",
    "DEFAULT_API_TIMEOUT",
    "MIN_API_TIMEOUT",
    "MAX_API_TIMEOUT",
    # Constants - Polling
    "HITL_POLL_INTERVAL",
    "MAX_POLL_ATTEMPTS",
    # Constants - Display
    "CONSOLE_REFRESH_RATE",
    "JSON_INDENT",
    "SEPARATOR_WIDTH",
    # Constants - Colors
    "COLOR_SUCCESS",
    "COLOR_WARNING",
    "COLOR_ERROR",
    "COLOR_INFO",
    "COLOR_MUTED",
    # Constants - Icons
    "ICON_SUCCESS",
    "ICON_WARNING",
    "ICON_ERROR",
    "ICON_INFO",
    "ICON_WORKING",
    # Constants - Exit codes
    "EXIT_SUCCESS",
    "EXIT_ERROR",
    "EXIT_CONFIG_ERROR",
    "EXIT_VALIDATION_ERROR",
    "EXIT_NETWORK_ERROR",
    # Constants - Validation
    "MAX_USER_ID_LENGTH",
    "MIN_USER_ID_LENGTH",
    # Security
    "validate_path_within_root",
    "sanitize_user_id",
    "validate_api_url",
    "validate_timeout",
]


============================================================
END FILE: src/skill_fleet/cli/utils/__init__.py
============================================================

============================================================
FILE: src/skill_fleet/cli/utils/constants.py
============================================================

"""
Constants for CLI configuration and theming.

Centralizes all magic numbers and configuration values
to improve maintainability and consistency.
"""

from __future__ import annotations

# API configuration
DEFAULT_API_URL = "http://localhost:8000"
DEFAULT_API_TIMEOUT = 30.0
MIN_API_TIMEOUT = 0.1
MAX_API_TIMEOUT = 300.0

# Polling configuration
HITL_POLL_INTERVAL = 2.0  # seconds between HITL polls
MAX_POLL_ATTEMPTS = 100  # maximum polling iterations

# Display configuration
CONSOLE_REFRESH_RATE = 10  # times per second for Live displays
JSON_INDENT = 2  # spaces for JSON output
SEPARATOR_WIDTH = 60  # characters for separator lines

# Rich color palette (consistent theming)
COLOR_SUCCESS = "green"
COLOR_WARNING = "yellow"
COLOR_ERROR = "red"
COLOR_INFO = "cyan"
COLOR_MUTED = "dim"

# Icons for status messages
ICON_SUCCESS = "✓"
ICON_WARNING = "⚠️"
ICON_ERROR = "❌"
ICON_INFO = "ℹ️"
ICON_WORKING = "⏳"

# Exit codes (same as in exceptions.py)
EXIT_SUCCESS = 0
EXIT_ERROR = 1
EXIT_CONFIG_ERROR = 2
EXIT_VALIDATION_ERROR = 3
EXIT_NETWORK_ERROR = 4

# Validation constraints
MAX_USER_ID_LENGTH = 100
MIN_USER_ID_LENGTH = 1


============================================================
END FILE: src/skill_fleet/cli/utils/constants.py
============================================================

============================================================
FILE: src/skill_fleet/cli/utils/security.py
============================================================

"""Security utilities for input validation and sanitization."""

import re
import warnings
from pathlib import Path
from urllib.parse import urlparse


