<!-- Chunk 1280: bytes 4731560-4732773, type=function -->
def evaluate_program(
    program: dspy.Module,
    testset: list[dspy.Example],
    metric,
) -> dict:
    """
    Evaluate program on test set.

    Args:
        program: DSPy program to evaluate
        testset: Test examples
        metric: Evaluation metric function

    Returns:
        Dictionary of evaluation results

    """
    logger.info(f"Evaluating on {len(testset)} test examples...")

    from dspy.evaluate import Evaluate

    evaluator = Evaluate(
        devset=testset,
        metric=metric,
        num_threads=8,
        display_progress=True,
    )

    score = evaluator(program)

    # Convert to float if needed (DSPy may return EvaluationResult)
    if hasattr(score, "__float__") or isinstance(score, (int, float)):
        score_float = float(score)
    else:
        # Default to string representation and extract number
        score_str = str(score)
        try:
            score_float = float(score_str)
        except (ValueError, TypeError):
            logger.warning(f"Could not convert score to float: {score_str}")
            score_float = 0.0

    logger.info(f"Evaluation score: {score_float:.3f}")
    return {"score": score_float, "num_examples": len(testset)}


