<!-- Chunk 1891: bytes 7693648-7697031, type=class -->
class JobRepository(BaseRepository[Job]):
    """Repository for Job entity."""

    def __init__(self, db: Session):
        """
        Initialize the job repository.

        Args:
            db: The database session.

        """
        super().__init__(Job, db)

    def get_by_id(self, job_id: Any) -> Job | None:
        """
        Get a job by its ID (UUID).

        Args:
            job_id: UUID of the job

        Returns:
            Job instance or None if not found

        """
        from uuid import UUID

        if isinstance(job_id, str):
            job_id = UUID(job_id)
        return self.db.query(Job).filter(Job.job_id == job_id).first()

    def get_by_status(self, status: str, *, limit: int = 100) -> list[Job]:
        """
        Get all jobs with a specific status.

        Args:
            status: Job status (pending, running, pending_hitl, completed, failed, cancelled)
            limit: Maximum number of jobs to return

        Returns:
            List of Job instances

        """
        return (
            self.db.query(Job)
            .filter(Job.status == status)
            .order_by(Job.created_at.asc())
            .limit(limit)
            .all()
        )

    def get_by_user(
        self,
        user_id: str,
        *,
        skip: int = 0,
        limit: int = 50,
        status: str | None = None,
    ) -> list[Job]:
        """Get jobs for a specific user."""
        query = self.db.query(Job).filter(Job.user_id == user_id)

        if status:
            query = query.filter(Job.status == status)

        return query.order_by(Job.created_at.desc()).offset(skip).limit(limit).all()

    def get_pending_hitl(self, *, limit: int = 10) -> list[Job]:
        """Get jobs that are waiting for human input."""
        return (
            self.db.query(Job)
            .filter(Job.status == "pending_hitl")
            .order_by(Job.created_at.asc())
            .limit(limit)
            .all()
        )

    def update_status(self, job_id: str, status: str, **updates: Any) -> Job | None:
        """Update job status and optionally other fields."""
        job = self.db.query(Job).filter(Job.job_id == job_id).first()
        if job:
            job.status = status
            for key, value in updates.items():
                if hasattr(job, key):
                    setattr(job, key, value)
            self.db.commit()
            self.db.refresh(job)
        return job

    def add_hitl_interaction(
        self,
        job_id: str,
        interaction_type: str,
        prompt_data: dict,
    ) -> HITLInteraction:
        """Add a HITL interaction to a job."""
        interaction = HITLInteraction(
            job_id=job_id,
            interaction_type=interaction_type,
            prompt_data=prompt_data,
        )
        self.db.add(interaction)
        self.db.commit()
        self.db.refresh(interaction)
        return interaction

    def complete_job(self, job_id: str, result: dict) -> Job | None:
        """Mark a job as completed with result."""
        job = self.db.query(Job).filter(Job.job_id == job_id).first()
        if job:
            job.status = "completed"
            job.result = result
            job.completed_at = datetime.now(UTC)
            job.progress_percent = 100
            self.db.commit()
            self.db.refresh(job)
        return job


