<!-- Chunk 1879: bytes 7661975-7665576, type=class -->
class Job(Base):
    """Background job tracking."""

    __tablename__ = "jobs"

    job_id: Mapped[UUID] = mapped_column(primary_key=True, server_default=func.uuid_generate_v4())
    status: Mapped[str] = mapped_column(
        Enum(
            JobStatusEnum.PENDING,
            JobStatusEnum.RUNNING,
            JobStatusEnum.PENDING_HITL,
            JobStatusEnum.PENDING_USER_INPUT,
            JobStatusEnum.PENDING_REVIEW,
            JobStatusEnum.COMPLETED,
            JobStatusEnum.FAILED,
            JobStatusEnum.CANCELLED,
            name="job_status_enum",
            create_constraint=True,
        ),
        nullable=False,
        default=JobStatusEnum.PENDING,
    )
    job_type: Mapped[str] = mapped_column(String(64), nullable=False, default="skill_creation")
    user_id: Mapped[str] = mapped_column(String(128), nullable=False, default="default")
    user_context: Mapped[dict] = mapped_column(JSONB, server_default=text("'{}'::jsonb"))
    task_description: Mapped[str] = mapped_column(Text, nullable=False)
    task_description_refined: Mapped[str | None] = mapped_column(Text, nullable=True)
    current_phase: Mapped[str | None] = mapped_column(String(64), nullable=True)
    progress_message: Mapped[str | None] = mapped_column(Text, nullable=True)
    progress_percent: Mapped[int] = mapped_column(Integer, default=0)
    result: Mapped[dict | None] = mapped_column(JSONB, nullable=True)
    error: Mapped[str | None] = mapped_column(Text, nullable=True)
    error_stack: Mapped[str | None] = mapped_column(Text, nullable=True)
    intended_taxonomy_path: Mapped[str | None] = mapped_column(String(512), nullable=True)
    draft_path: Mapped[str | None] = mapped_column(Text, nullable=True)
    final_path: Mapped[str | None] = mapped_column(Text, nullable=True)
    promoted: Mapped[bool] = mapped_column(Boolean, nullable=False, default=False)
    validation_passed: Mapped[bool | None] = mapped_column(Boolean, nullable=True)
    validation_status: Mapped[str | None] = mapped_column(
        Enum(
            ValidationStatusEnum.PASSED,
            ValidationStatusEnum.FAILED,
            ValidationStatusEnum.WARNINGS,
            name="validation_status_enum",
            create_constraint=True,
        ),
        nullable=True,
    )
    validation_score: Mapped[float | None] = mapped_column(Integer, nullable=True)
    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False, server_default=func.now()
    )
    updated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False, server_default=func.now(), onupdate=func.now()
    )
    started_at: Mapped[datetime | None] = mapped_column(DateTime(timezone=True), nullable=True)
    completed_at: Mapped[datetime | None] = mapped_column(DateTime(timezone=True), nullable=True)
    job_metadata: Mapped[dict] = mapped_column(JSONB, server_default=text("'{}'::jsonb"))

    # HITL fields
    hitl_type: Mapped[str | None] = mapped_column(String(32), nullable=True)
    hitl_data: Mapped[dict | None] = mapped_column(JSONB, nullable=True)

    # Relationships
    hitl_interactions: Mapped[list["HITLInteraction"]] = relationship(
        "HITLInteraction", back_populates="job", cascade="all, delete-orphan"
    )

    __table_args__ = (
        Index("idx_jobs_status", "status"),
        Index("idx_jobs_user", "user_id"),
        Index("idx_jobs_created_at", "created_at"),
        Index("idx_jobs_type", "job_type"),
        Index("idx_jobs_promoted", "promoted"),
        Index("idx_jobs_polling", "user_id", "created_at"),
    )


