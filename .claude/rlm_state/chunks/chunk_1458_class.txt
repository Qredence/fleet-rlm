<!-- Chunk 1458: bytes 6295056-6296817, type=class -->
class UsageTracker:
    """Tracks skill usage events in a JSONL log file."""

    def __init__(self, analytics_root: Path, *, trusted_root: Path | None = None) -> None:
        analytics_root_path = Path(analytics_root)

        # Defensive path validation: allow callers to constrain analytics output
        # to a known-safe root (e.g., skills_root) to prevent traversal/redirects.
        if trusted_root is not None:
            trusted_root_resolved = Path(trusted_root).resolve()
            analytics_root_resolved = analytics_root_path.resolve(strict=False)
            try:
                analytics_root_resolved.relative_to(trusted_root_resolved)
            except ValueError as e:
                raise ValueError(
                    f"Analytics root must be within {trusted_root_resolved}. Got: {analytics_root_resolved}"
                ) from e
            self.analytics_root = analytics_root_resolved
        else:
            self.analytics_root = analytics_root_path.resolve(strict=False)

        self.analytics_root.mkdir(parents=True, exist_ok=True)
        self.usage_file = self.analytics_root / "usage_log.jsonl"

    def track_usage(
        self,
        skill_id: str,
        user_id: str,
        success: bool = True,
        task_id: str | None = None,
        metadata: dict[str, Any] | None = None,
    ) -> None:
        """Record a skill usage event."""
        entry = {
            "timestamp": datetime.now(tz=UTC).isoformat(),
            "skill_id": skill_id,
            "user_id": user_id,
            "success": success,
            "task_id": task_id,
            "metadata": metadata or {},
        }
        with self.usage_file.open("a", encoding="utf-8") as f:
            f.write(json.dumps(entry) + "\n")


