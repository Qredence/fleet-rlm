<!-- Chunk 938: bytes 3402494-3407785, type=function -->
def display_error(error: CLIError):
    """Display error with consistent formatting."""
    console.print(Panel(
        f"[bold red]Error:[/bold red] {error.message}\n\n"
        f"{error.suggestion}",
        title="Error",
        border_style="red"
    ))

    if error.exit_code != 0:
        console.print(f"\n[yellow]Exit code: {error.exit_code}[/yellow]")
```

### 3. Replace All Error Handling

```python
# Before
except Exception as e:
    print(f"Error: {e}", file=sys.stderr)
    return 1

# After
except APIError as e:
    display_error(e)
    return e.exit_code
```

### 4. Define Exit Code Standard

```python
# Exit codes
EXIT_SUCCESS = 0
EXIT_ERROR = 1
EXIT_CONFIG_ERROR = 2
EXIT_VALIDATION_ERROR = 3
EXIT_NETWORK_ERROR = 4
```

## Acceptance Criteria

- [ ] Custom exception classes defined
- [ ] Error display utility created
- [ ] All bare `except Exception` replaced
- [ ] Consistent Rich formatting for all errors
- [ ] Actionable suggestions provided
- [ ] Exit code standard documented
- [ ] All error messages tested

## Resources
- Rich docs: https://rich.readthedocs.io/
- Python exceptions: https://docs.python.org/3/library/exceptions.html
EOF
```

**Step 2: Commit issue templates**

```bash
git add docs/plans/cli-review-issues/
git commit -m "docs: add actionable issue templates for CLI review"
```

---

## Summary

This comprehensive code review plan:

1. **Analyzes architecture** - Identifies dual CLI implementation problem
2. **Reviews code quality** - Finds long functions, duplication, magic numbers
3. **Assesses testing** - Identifies minimal coverage (90% of commands untested)
4. **Checks documentation** - Finds missing docstrings, inconsistent formats
5. **Examines error handling** - Finds bare excepts, inconsistent patterns
6. **Reviews dependencies** - Identifies unused imports, potential circular deps
7. **Assesses security** - Finds missing path validation, input sanitization
8. **Checks best practices** - Verifies Typer, Rich, async patterns
9. **Creates comprehensive summary** - Prioritized action items with phases
10. **Generates issue templates** - Actionable tickets for critical issues

**Estimated Total Effort:** 2-3 days for full review execution
**Expected Deliverables:** 4 detailed review docs + 1 summary + 3 issue templates

**Files Created:**
- `docs/plans/cli-review-architecture.md`
- `docs/plans/cli-test-coverage.md`
- `docs/plans/cli-documentation-review.md`
- `docs/plans/cli-error-handling-review.md`
- `docs/plans/cli-dependencies-review.md`
- `docs/plans/cli-security-review.md`
- `docs/plans/cli-best-practices-review.md`
- `docs/plans/CLI_CODE_REVIEW_SUMMARY.md`
- `tests/cli/test_cli_commands.py`
- `docs/plans/cli-review-issues/001-dual-cli-implementation.md`
- `docs/plans/cli-review-issues/002-add-cli-test-coverage.md`
- `docs/plans/cli-review-issues/003-standardize-error-handling.md`

**Execution Approach:**
Run tasks sequentially using `superpowers:executing-plans` skill. Each task is bite-sized (2-5 min steps) with clear verification.


============================================================
END FILE: docs/internal/plans/archive/2026-01-12-cli-code-review.md
============================================================

============================================================
FILE: docs/internal/plans/archive/2026-01-12-cli-optimization-fix.md
============================================================

# CLI Optimization and Fix Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix security vulnerabilities, standardize error handling, improve code quality, and optimize the CLI implementation in `src/skill_fleet/cli/` based on findings from comprehensive code reviews.

**Architecture:** Create shared utilities for common patterns (console management, error handling, input validation), refactor command files to use them, add security layers, and improve test coverage.

**Tech Stack:** Python 3.12+, Typer, Rich, httpx, pytest, ruff

---

## Overview

Based on the existing reviews (`docs/plans/cli-*.md`), this plan addresses:

1. **Security** (High Priority): Path traversal validation, URL validation, user ID sanitization
2. **Error Handling** (High Priority): Custom exceptions, consistent formatting, actionable messages
3. **Code Quality** (Medium Priority): Singleton console, constants, type hints, refactor long functions
4. **Testing** (High Priority): Add test coverage for CLI commands

**Files to Modify:**
- `src/skill_fleet/cli/` - All existing files
- `src/skill_fleet/cli/utils/` - New shared utilities
- `src/skill_fleet/cli/exceptions.py` - New custom exceptions
- `tests/cli/` - New test files

---

## Task 1: Create Security and Validation Utilities

**Files:**
- Create: `src/skill_fleet/cli/exceptions.py`
- Create: `src/skill_fleet/cli/utils/security.py`
- Create: `src/skill_fleet/cli/utils/constants.py`
- Modify: `src/skill_fleet/cli/utils/__init__.py`

**Step 1: Write the failing test for path validation**

Create `tests/cli/test_security_utils.py`:

```python
"""Tests for CLI security utilities."""

import pytest
from pathlib import Path

from skill_fleet.cli.utils.security import validate_path_within_root, sanitize_user_id, validate_api_url


