<!-- Chunk 2045: bytes 7945140-7946853, type=class -->
class TestMemoryCacheManagement:
    """Test memory cache TTL and cleanup behavior."""

    def test_cache_expiration_by_ttl(self):
        """Test that jobs expire from cache after TTL."""
        from datetime import timedelta

        manager = JobManager()
        store = manager.memory
        job_id = "expiring-job"
        job = JobState(job_id=job_id, status="pending")

        store.set(job_id, job)
        assert store.get(job_id) is not None

        # Manually expire
        store.store[job_id] = (job, datetime.now(UTC) - timedelta(minutes=120))

        # Should be expired now
        assert store.get(job_id) is None

    def test_cleanup_removes_expired_entries(self):
        """Test that cleanup removes expired entries."""
        from datetime import timedelta

        manager = JobManager()
        store = manager.memory

        for i in range(3):
            job = JobState(job_id=f"job-{i}", status="pending")
            store.set(f"job-{i}", job)

        # Manually expire all
        past = datetime.now(UTC) - timedelta(minutes=120)
        for job_id in list(store.store.keys()):
            job, _ = store.store[job_id]
            store.store[job_id] = (job, past)

        # Cleanup
        cleaned = store.cleanup_expired()
        assert cleaned == 3
        assert len(store.store) == 0

    def test_cleanup_keeps_valid_entries(self):
        """Test that cleanup doesn't remove valid entries."""
        manager = JobManager()
        store = manager.memory

        job = JobState(job_id="valid", status="pending")
        store.set("valid", job)

        cleaned = store.cleanup_expired()
        assert cleaned == 0
        assert store.get("valid") is not None


