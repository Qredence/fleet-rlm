<!-- Chunk 2106: bytes 8032877-8037246, type=function -->
def test_validate_complete_blocks_skill_md_symlink_escape(temp_skills_root: Path) -> None:
    """Ensure SKILL.md symlinks are rejected (avoid reading outside skills_root)."""
    # Arrange
    validator = SkillValidator(temp_skills_root)

    skill_dir = temp_skills_root / "general/symlink_skill_md"
    skill_dir.mkdir(parents=True)
    # NOTE: No subdirectories - they are optional in v2

    outside_md = temp_skills_root.parent / "outside-skill.md"
    outside_md.write_text(
        """---
name: outside-skill
description: A skill outside the skills root.
---

# Outside Skill

## When to Use This Skill
Never use this.
""",
        encoding="utf-8",
    )

    skill_md_link = skill_dir / "SKILL.md"
    try:
        skill_md_link.symlink_to(outside_md)
    except (OSError, NotImplementedError):
        pytest.skip("Symlinks not supported in this environment")

    # Act
    results = validator.validate_complete(skill_dir)

    # Assert
    assert results["passed"] is False
    assert any("SKILL.md must not be a symlink" in e for e in results["errors"])


============================================================
END FILE: tests/unit/test_skill_validator.py
============================================================

============================================================
FILE: tests/unit/test_streaming_reasoning_serialization.py
============================================================

import json

import dspy
import pytest
from pydantic import BaseModel

from skill_fleet.common.streaming import StubPrediction, stream_dspy_response


@pytest.mark.asyncio
async def test_stream_serializes_reasoning_labels() -> None:
    async def mock_stream(**kwargs):
        yield StubPrediction({"answer": "42", "reasoning": dspy.Reasoning(content="why")})

    results = []
    async for chunk in stream_dspy_response(mock_stream):
        results.append(chunk)

    assert len(results) == 2

    payload = json.loads(results[0].removeprefix("data: ").strip())
    assert payload["type"] == "prediction"
    assert payload["data"]["answer"] == "42"
    assert payload["data"]["reasoning"] == "why"


@pytest.mark.asyncio
async def test_stream_serializes_nested_reasoning_labels() -> None:
    async def mock_stream(**kwargs):
        yield StubPrediction(
            {
                "nested": [
                    dspy.Reasoning(content="first"),
                    {"inner": (dspy.Reasoning(content="second"),)},
                ]
            }
        )

    results = []
    async for chunk in stream_dspy_response(mock_stream):
        results.append(chunk)

    payload = json.loads(results[0].removeprefix("data: ").strip())
    assert payload["data"]["nested"][0] == "first"
    assert payload["data"]["nested"][1]["inner"][0] == "second"


@pytest.mark.asyncio
async def test_stream_serializes_model_dump_reasoning() -> None:
    class Payload(BaseModel):
        reasoning: dspy.Reasoning
        items: list[str]

    async def mock_stream(**kwargs):
        yield StubPrediction(
            {"payload": Payload(reasoning=dspy.Reasoning(content="why"), items=["a"])}
        )

    results = []
    async for chunk in stream_dspy_response(mock_stream):
        results.append(chunk)

    payload = json.loads(results[0].removeprefix("data: ").strip())
    assert payload["data"]["payload"]["reasoning"] == "why"
    assert payload["data"]["payload"]["items"] == ["a"]


@pytest.mark.asyncio
async def test_stream_serializes_cycles_as_placeholder() -> None:
    async def mock_stream(**kwargs):
        data: dict[str, object] = {}
        data["self"] = data
        yield StubPrediction({"cycle": data})

    results = []
    async for chunk in stream_dspy_response(mock_stream):
        results.append(chunk)

    payload = json.loads(results[0].removeprefix("data: ").strip())
    assert payload["data"]["cycle"]["self"] == "<cycle>"


============================================================
END FILE: tests/unit/test_streaming_reasoning_serialization.py
============================================================

============================================================
FILE: tests/unit/test_taxonomy_bundled_resources.py
============================================================

import json
from pathlib import Path

import pytest

from skill_fleet.taxonomy.manager import TaxonomyManager


@pytest.fixture
