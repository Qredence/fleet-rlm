<!-- Chunk 1894: bytes 7701137-7704358, type=class -->
class UsageRepository:
    """Repository for usage analytics."""

    def __init__(self, db: Session):
        """
        Initialize the usage repository.

        Args:
            db: The database session.

        """
        self.db = db

    def record_usage(
        self,
        skill_id: int,
        user_id: str,
        *,
        success: bool = True,
        duration_ms: int | None = None,
        error_type: str | None = None,
        session_id: str | None = None,
        metadata: dict | None = None,
    ) -> UsageEvent:
        """Record a skill usage event."""
        event = UsageEvent(
            skill_id=skill_id,
            user_id=user_id,
            success=success,
            duration_ms=duration_ms,
            error_type=error_type,
            session_id=session_id,
            metadata=metadata or {},
        )
        self.db.add(event)
        self.db.commit()
        self.db.refresh(event)
        return event

    def get_skill_stats(
        self,
        skill_id: int,
        *,
        days: int = 30,
    ) -> dict:
        """Get usage statistics for a skill."""
        from datetime import timedelta

        from sqlalchemy import func

        since = datetime.now(UTC) - timedelta(days=days)

        stats = (
            self.db.query(
                func.count(UsageEvent.event_id).label("total_uses"),
                func.count(func.distinct(UsageEvent.user_id)).label("unique_users"),
                func.avg(UsageEvent.success.cast("integer")).label("success_rate"),
                func.avg(UsageEvent.duration_ms).label("avg_duration_ms"),
            )
            .filter(
                UsageEvent.skill_id == skill_id,
                UsageEvent.occurred_at >= since,
            )
            .first()
        )

        return {
            "total_uses": stats.total_uses or 0,
            "unique_users": stats.unique_users or 0,
            "success_rate": float(stats.success_rate or 0),
            "avg_duration_ms": float(stats.avg_duration_ms or 0),
        }

    def get_popular_skills(self, *, days: int = 30, limit: int = 20) -> list[dict]:
        """Get the most popular skills by usage."""
        from datetime import timedelta

        from sqlalchemy import desc, func

        since = datetime.now(UTC) - timedelta(days=days)

        results = (
            self.db.query(
                Skill.skill_id,
                Skill.skill_path,
                Skill.name,
                func.count(UsageEvent.event_id).label("usage_count"),
                func.count(func.distinct(UsageEvent.user_id)).label("unique_users"),
            )
            .join(UsageEvent, Skill.skill_id == UsageEvent.skill_id)
            .filter(UsageEvent.occurred_at >= since)
            .group_by(Skill.skill_id, Skill.skill_path, Skill.name)
            .order_by(desc("usage_count"))
            .limit(limit)
            .all()
        )

        return [
            {
                "skill_id": r.skill_id,
                "skill_path": r.skill_path,
                "name": r.name,
                "usage_count": r.usage_count,
                "unique_users": r.unique_users,
            }
            for r in results
        ]


