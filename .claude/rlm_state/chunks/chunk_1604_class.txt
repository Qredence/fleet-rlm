<!-- Chunk 1604: bytes 6605016-6607490, type=class -->
class TDDRedHandler(InteractionHandler):
    """
    Handler for tdd_red interaction type.

    TDD Red Phase: User writes failing tests before implementation.
    Shows test requirements, acceptance criteria, and checklist.
    Tracks any rationalizations detected.

    User Actions:
    - proceed: Tests written and failing as expected
    - revise: Revise the test requirements
    - cancel: Cancel skill creation
    """

    async def handle(
        self,
        job_id: str,
        prompt_data: dict[str, Any],
        client: Any,
    ) -> None:
        """Handle TDD red phase interaction and post response to API."""
        requirements = prompt_data.get("test_requirements", "")
        acceptance = prompt_data.get("acceptance_criteria", [])
        checklist = prompt_data.get("checklist_items", [])
        rationalizations = prompt_data.get("rationalizations_identified", [])

        self.console.print(
            Panel(
                Markdown(requirements) if "**" in requirements else requirements,
                title="[bold red]üî¥ TDD Red Phase: Write Failing Tests[/bold red]",
                border_style="red",
            )
        )

        if acceptance:
            self.console.print("[dim]Acceptance criteria:[/dim]")
            for i, criterion in enumerate(acceptance, 1):
                self.console.print(f"  {i}. {criterion}")

        if checklist:
            self.console.print("[dim]Checklist:[/dim]")
            for _i, item in enumerate(checklist, 1):
                text = item.get("text", item) if isinstance(item, dict) else item
                done = item.get("done", False) if isinstance(item, dict) else False
                self.console.print(f"  {'‚òë' if done else '‚òê'} {text}")

        if rationalizations:
            self.console.print("[yellow]Rationalizations detected:[/yellow]")
            for r in rationalizations:
                self.console.print(f"  ‚ö†Ô∏è  {r}")

        action = await self.ui.choose_one(
            "Tests written?",
            [
                ("proceed", "Yes, tests fail as expected"),
                ("revise", "Revise requirements"),
                ("cancel", "Cancel"),
            ],
            default_id="proceed",
        )

        payload: dict[str, object] = {"action": action}
        if action == "revise":
            payload["feedback"] = await self.ui.ask_text("What should change?", default="")
        await client.post_hitl_response(job_id, payload)


