<!-- Chunk 1024: bytes 3617777-3626497, type=class -->
class TestOptimizerSelector:
    """Test OptimizerSelector decision rules."""

    @pytest.fixture
    def selector(self) -> OptimizerSelector:
        """Create selector without historical data."""
        return OptimizerSelector()

    # =========================================================================
    # Decision Rule Tests
    # =========================================================================

    def test_very_tight_time_constraint_recommends_reflection_metrics(
        self, selector: OptimizerSelector
    ):
        """Time < 2min → Reflection Metrics."""
        context = OptimizerContext(
            trainset_size=100,
            budget_dollars=50.0,
            time_constraint_minutes=1,
        )
        result = selector.recommend(context)
        
        assert result.recommended == OptimizerType.REFLECTION_METRICS
        assert "Time constraint" in result.reasoning

    def test_very_low_budget_recommends_reflection_metrics(
        self, selector: OptimizerSelector
    ):
        """Budget < $1 → Reflection Metrics."""
        context = OptimizerContext(
            trainset_size=100,
            budget_dollars=0.50,
        )
        result = selector.recommend(context)
        
        assert result.recommended == OptimizerType.REFLECTION_METRICS
        assert "Budget" in result.reasoning

    def test_small_trainset_low_budget_recommends_gepa(
        self, selector: OptimizerSelector
    ):
        """trainset < 100 AND budget < $5 → GEPA."""
        context = OptimizerContext(
            trainset_size=50,
            budget_dollars=4.0,
        )
        result = selector.recommend(context)
        
        assert result.recommended == OptimizerType.GEPA
        assert "GEPA" in result.reasoning

    def test_medium_trainset_moderate_budget_recommends_miprov2_light(
        self, selector: OptimizerSelector
    ):
        """trainset < 500 AND budget < $20 → MIPROv2 light."""
        context = OptimizerContext(
            trainset_size=200,
            budget_dollars=15.0,
        )
        result = selector.recommend(context)
        
        assert result.recommended == OptimizerType.MIPROV2
        assert result.config.auto == "light"

    def test_large_trainset_good_budget_recommends_miprov2_medium(
        self, selector: OptimizerSelector
    ):
        """trainset >= 500 AND budget >= $20 → MIPROv2 medium."""
        context = OptimizerContext(
            trainset_size=500,
            budget_dollars=50.0,
        )
        result = selector.recommend(context)
        
        assert result.recommended == OptimizerType.MIPROV2
        assert result.config.auto == "medium"

    def test_high_budget_recommends_miprov2_heavy(
        self, selector: OptimizerSelector
    ):
        """budget >= $100 → MIPROv2 heavy."""
        context = OptimizerContext(
            trainset_size=500,
            budget_dollars=150.0,
            quality_target=0.90,
        )
        result = selector.recommend(context)
        
        assert result.recommended == OptimizerType.MIPROV2
        assert result.config.auto == "heavy"

    def test_very_high_budget_high_quality_recommends_finetune(
        self, selector: OptimizerSelector
    ):
        """budget >= $100 AND quality_target >= 0.95 → BootstrapFinetune."""
        context = OptimizerContext(
            trainset_size=1000,
            budget_dollars=200.0,
            quality_target=0.95,
        )
        result = selector.recommend(context)
        
        assert result.recommended == OptimizerType.BOOTSTRAP_FINETUNE

    def test_fallback_to_bootstrap_fewshot(
        self, selector: OptimizerSelector
    ):
        """Edge case defaults to BootstrapFewShot."""
        # Context that doesn't match other rules
        context = OptimizerContext(
            trainset_size=150,
            budget_dollars=8.0,  # Between rule boundaries
        )
        result = selector.recommend(context)
        
        # Should match either GEPA or fallback
        assert result.recommended in [
            OptimizerType.GEPA,
            OptimizerType.BOOTSTRAP_FEWSHOT,
            OptimizerType.MIPROV2,
        ]

    # =========================================================================
    # Cost & Time Estimation Tests
    # =========================================================================

    def test_cost_estimation_scales_with_trainset(
        self, selector: OptimizerSelector
    ):
        """Cost should scale with trainset size."""
        context_small = OptimizerContext(trainset_size=50, budget_dollars=20.0)
        context_large = OptimizerContext(trainset_size=500, budget_dollars=20.0)
        
        result_small = selector.recommend(context_small)
        result_large = selector.recommend(context_large)
        
        # Larger trainset should cost more
        # (they may recommend different optimizers, but each should scale)
        assert result_large.estimated_cost >= result_small.estimated_cost * 2

    def test_time_estimation_is_reasonable(
        self, selector: OptimizerSelector
    ):
        """Time estimates should be in reasonable range."""
        context = OptimizerContext(trainset_size=100, budget_dollars=10.0)
        result = selector.recommend(context)
        
        assert result.estimated_time_minutes >= 1
        assert result.estimated_time_minutes <= 120  # Max 2 hours

    # =========================================================================
    # Confidence Tests
    # =========================================================================

    def test_confidence_baseline(self, selector: OptimizerSelector):
        """Confidence should be reasonable without historical data."""
        context = OptimizerContext(trainset_size=100, budget_dollars=10.0)
        result = selector.recommend(context)
        
        assert 0.5 <= result.confidence <= 1.0

    def test_confidence_reduced_for_tiny_trainset(
        self, selector: OptimizerSelector
    ):
        """Very small trainset should reduce confidence."""
        context = OptimizerContext(trainset_size=10, budget_dollars=10.0)
        result = selector.recommend(context)
        
        # Confidence should be lower for edge cases
        assert result.confidence <= 0.8

    # =========================================================================
    # Alternatives Tests
    # =========================================================================

    def test_alternatives_always_present(self, selector: OptimizerSelector):
        """Should always provide alternatives."""
        context = OptimizerContext(trainset_size=100, budget_dollars=10.0)
        result = selector.recommend(context)
        
        assert len(result.alternatives) >= 1
        assert len(result.alternatives) <= 3

    def test_alternatives_include_fast_option(
        self, selector: OptimizerSelector
    ):
        """Alternatives should include a fast option."""
        context = OptimizerContext(
            trainset_size=500,
            budget_dollars=50.0,
        )
        result = selector.recommend(context)
        
        # If not already fastest, should suggest it
        if result.recommended != OptimizerType.REFLECTION_METRICS:
            optimizer_names = [a["optimizer"] for a in result.alternatives]
            assert OptimizerType.REFLECTION_METRICS.value in optimizer_names

    # =========================================================================
    # Recommendation Structure Tests
    # =========================================================================

    def test_recommendation_has_all_fields(
        self, selector: OptimizerSelector
    ):
        """Recommendation should have all required fields."""
        context = OptimizerContext(trainset_size=100, budget_dollars=10.0)
        result = selector.recommend(context)
        
        assert isinstance(result.recommended, OptimizerType)
        assert result.config is not None
        assert result.estimated_cost >= 0
        assert result.estimated_time_minutes >= 1
        assert 0.0 <= result.confidence <= 1.0
        assert len(result.reasoning) > 0
        assert isinstance(result.alternatives, list)
```

**Run Tests**:
```bash
uv run pytest tests/unit/test_optimizer_selector.py -v
```

---

### Task 0.2.3: Add API Endpoint (~0.5 days)

**File**: `src/skill_fleet/api/routes/optimization.py` (update existing)

Add to the existing optimization routes:

```python
# Add these imports at top
from ...core.dspy.optimization.selector import (
    OptimizerContext,
    OptimizerRecommendation,
    OptimizerSelector,
    OptimizerType,
)

# Add these schemas after existing schemas
