name: Release to PyPI

on:
    workflow_dispatch:
        inputs:
            version:
                description: "Version to release (e.g., 0.1.0)"
                required: true
                type: string

permissions:
    contents: write
    id-token: write

jobs:
    preflight:
        name: Preflight Checks
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install uv
              uses: astral-sh/setup-uv@v5
              with:
                  version: "latest"
                  enable-cache: true
                  cache-dependency-glob: "uv.lock"

            - name: Set up Python
              run: uv python install

            - name: Install dependencies
              run: uv sync --all-extras --dev

            - name: Lint with Ruff
              run: |
                  uv run ruff check src tests config/test_responses_endpoint.py
                  uv run ruff format --check src tests config/test_responses_endpoint.py

            - name: Run tests
              run: uv run pytest

    build:
        name: Build Distribution
        runs-on: ubuntu-latest
        needs: preflight
        outputs:
            artifact_name: ${{ steps.artifact.outputs.name }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install uv
              uses: astral-sh/setup-uv@v5
              with:
                  version: "latest"

            - name: Clean previous builds
              run: rm -rf dist build

            - name: Build distributions
              run: uv build

            - name: Verify distributions
              run: uvx twine check dist/*

            - name: List artifacts
              run: ls -lh dist/

            - name: Upload distributions
              id: artifact
              uses: actions/upload-artifact@v4
              with:
                  name: python-package-distributions
                  path: dist/
                  retention-days: 7

    check-pypi-availability:
        name: Check PyPI Package Name
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Check if package exists on PyPI
              run: |
                  STATUS_CODE=$(curl -sS -o /dev/null -w "%{http_code}\n" https://pypi.org/pypi/fleet-rlm/json || true)
                  echo "Status code: $STATUS_CODE"
                  if [ "$STATUS_CODE" = "404" ]; then
                    echo "✅ Package name 'fleet-rlm' is available on PyPI"
                  else
                    echo "⚠️  Package 'fleet-rlm' already exists on PyPI. Version conflicts may occur."
                  fi

    publish-testpypi:
        name: Publish to TestPyPI
        runs-on: ubuntu-latest
        needs: [build, check-pypi-availability]
        continue-on-error: true
        environment:
            name: testpypi
            url: https://test.pypi.org/project/fleet-rlm/
        steps:
            - name: Download distributions
              uses: actions/download-artifact@v4
              with:
                  name: python-package-distributions
                  path: dist/

            - name: Publish to TestPyPI
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  repository-url: https://test.pypi.org/legacy/
                  skip-existing: true

    smoke-test-testpypi:
        name: Smoke Test from TestPyPI
        runs-on: ubuntu-latest
        needs: publish-testpypi
        continue-on-error: true
        if: success() || failure()
        steps:
            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Wait for TestPyPI indexing
              run: |
                  echo "⏳ Waiting 60 seconds for TestPyPI to index the new version..."
                  sleep 60

            - name: Install from TestPyPI
              run: |
                  python -m pip install --upgrade pip
                  # Retry up to 3 times with exponential backoff
                  for i in 1 2 3; do
                    echo "Attempt $i to install fleet-rlm==${{ inputs.version }}"
                    if pip install \
                      --index-url https://test.pypi.org/simple/ \
                      --extra-index-url https://pypi.org/simple \
                      fleet-rlm==${{ inputs.version }}; then
                      echo "✅ Successfully installed"
                      exit 0
                    fi
                    if [ $i -lt 3 ]; then
                      echo "⚠️ Install failed, waiting $((i * 30)) seconds before retry..."
                      sleep $((i * 30))
                    fi
                  done
                  echo "❌ Failed to install after 3 attempts"
                  exit 1

            - name: Test CLI availability
              run: |
                  fleet-rlm --help
                  echo "✅ CLI installed and accessible"

            - name: Test Python import
              run: |
                  python -c "import fleet_rlm; print(f'✅ Package version: {fleet_rlm.__version__}')"

    publish-pypi:
        name: Publish to PyPI
        runs-on: ubuntu-latest
        needs: [build, smoke-test-testpypi]
        if: always() && needs.build.result == 'success'
        environment:
            name: pypi
            url: https://pypi.org/project/fleet-rlm/
        steps:
            - name: Download distributions
              uses: actions/download-artifact@v4
              with:
                  name: python-package-distributions
                  path: dist/

            - name: Publish to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1

    create-release:
        name: Create GitHub Release
        runs-on: ubuntu-latest
        needs: publish-pypi
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download distributions
              uses: actions/download-artifact@v4
              with:
                  name: python-package-distributions
                  path: dist/

            - name: Create Git tag
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"
                  git push origin "v${{ inputs.version }}"

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v${{ inputs.version }}
                  name: Release v${{ inputs.version }}
                  draft: false
                  prerelease: false
                  files: dist/*
                  body: |
                      ## Release v${{ inputs.version }}

                      ### Installation

                      ```bash
                      pip install fleet-rlm==${{ inputs.version }}
                      ```

                      ### CLI Usage

                      ```bash
                      fleet-rlm --help
                      ```

                      ### What's Changed

                      Please see [RELEASING.md](https://github.com/${{ github.repository }}/blob/main/RELEASING.md) for the complete release process.

                      **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ inputs.version }}...main
